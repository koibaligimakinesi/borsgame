<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BÖRSGAME: Kayıp Klanın Sırrı - Genişletilmiş Açık Dünya</title>
<style>
  :root{
    --bg:#1a0a2a; 
    --panel:#2b1a3b; 
    --accent:#e0b0ff; 
    --muted:#c2a0d6; 
    --card:#3a2a4a; 
    --border:#4a3a5a; 
    --shadow:rgba(0,0,0,0.3); 
    --button-bg:#6a3a8a; 
    --button-hover:#8a5a9a; 
    --button-ghost:#4a3a5a; 
    --text:#f0e6f5; 
    --danger:#ff6b6b; 
    --success:#6bff6b; 
  }
  body{
    margin:0;
    font-family:Inter,system-ui,Arial;
    background:linear-gradient(180deg,var(--bg),#2a1a3a); 
    color:var(--text);
    padding:0;
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:flex-start;
  }
  .wrap{
    width:min(960px,98vw);
    display:flex;
    flex-direction:column;
    margin:40px 0 40px 0;
    gap:24px;
  }
  .top{
    display:grid;
    grid-template-columns:320px 1fr;
    gap:20px;
    margin-bottom:0;
  }
  .card{
    background:var(--card);
    border-radius:12px;
    box-shadow:0 3px 18px var(--shadow);
    border:1px solid var(--border);
    padding:20px 18px 15px 18px;
    margin-bottom:0;
  }
  .left{ text-align:center; }
  .right{ width:100%; }

  h1{
    margin:0 0 6px 0;
    font-size:20px;
    color:var(--accent);
    font-weight:700;
    letter-spacing:0.02em;
  }
  h3{
    margin:0 0 6px 0;
    font-size:15px;
    color:var(--accent);
    font-weight:600;
  }
  .muted{
    color:var(--muted);
    font-size:13px;
    margin-bottom:5px;
  }
  .panel-row{
    display:flex;
    gap:8px;
    justify-content:center;
    margin-top:8px;
  }
  button{
    appearance:none;
    border:0;
    background:var(--button-bg);
    color:var(--text);
    padding:8px 16px;
    border-radius:8px;
    font-weight:600;
    cursor:pointer;
    font-size:14px;
    transition:background 0.15s, color 0.15s;
    box-shadow:0 2px 8px rgba(0,0,0,0.06);
    outline:none;
  }
  button:hover{ background:var(--button-hover);}
  button.ghost{
    background:var(--button-ghost);
    color:var(--muted);
    border:1px solid var(--border);
  }
  button.ghost:hover{ background:rgba(224,176,255,0.06);} 
  button.danger{ background:var(--danger);}
  button.danger:hover{ background:#ff8b8b;}
  button.success{ background:var(--success);}
  button.success:hover{ background:#8bff8b;}
  .selection-area{
    margin:10px auto 0 auto;
    width:100%;
    min-height:160px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
  }
  .options-list{
    list-style:none;
    padding:0;
    margin:0;
    width:98%;
    max-height:120px;
    overflow-y:auto;
    text-align:left;
  }
  .options-list li{
    padding:6px 10px;
    border-bottom:1px solid var(--border);
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:14px;
    border-radius:5px;
    transition:background 0.16s;
  }
  .options-list li:last-child{ border-bottom:none;}
  .options-list li.highlight{ background:rgba(224,176,255,0.12);} 
  .options-list li .probability{ font-size:12px;color:var(--muted);}
  .stat-row{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:5px;
    margin-top:8px;
    margin-bottom:0;
  }
  .stat{
    background:rgba(255,255,255,0.03);
    padding:6px 9px;
    border-radius:6px;
    font-weight:600;
    color:var(--text);
    font-size:13px;
    margin-bottom:2px;
  }
  .inventory-stat{ margin-top:6px;font-size:12px;}
  .game-panel{ margin-top:12px;}
  .game-layout{
    display:flex;
    flex-direction:column;
    gap:20px;
  }
  .game-main-area{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:0;
    margin-bottom:0;
  }
  .game-stats-area{
    background:var(--panel);
    border-radius:10px;
    border:1px solid var(--border);
    padding:12px;
    margin-top:0;
    margin-bottom:0;
  }
  .log{
    min-height:100px;
    max-height:160px;
    overflow:auto;
    background:rgba(255,255,255,0.015);
    border-radius:7px;
    padding:9px;
    margin-top:9px;
    font-size:12px;
    color:var(--muted);
    scrollbar-width:thin;
  }
  .result-card{
    background:linear-gradient(180deg,var(--panel),#1a0a2a); 
    padding:12px 12px 9px 12px;
    border-radius:9px;
    border:1px solid var(--border);
    margin-top:9px;
    margin-bottom:0;
    color:var(--text);
  }
  .actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin:12px 0 0 0;
    justify-content:center;
  }
  .actions button{
    flex:1 1 120px;
    min-width:100px;
    margin-bottom:4px;
  }
  .player-hp{ color:#ffb0e0;font-weight:600;} 
  .enemy-hp{ color:#e0b0ff;font-weight:600;} 
  .story-text{ line-height:1.5;margin-bottom:12px;}
  .inventory-item, .quest-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    border-bottom: 1px solid var(--border);
    font-size:13px;
  }
  .inventory-item:last-child, .quest-item:last-child { border-bottom: none; }
  .inventory-item-actions button {
    padding: 3px 8px;
    font-size: 11px;
    margin-left: 4px;
  }
  .inventory-item-actions{
    display:flex;
    gap:5px;
  }
  .hidden{ display:none;}
  #gameStatsDisplay .stat-row{ margin-top:0; }
  @media (max-width:900px){
    .top{ display:flex; flex-direction:column; gap:12px;}
    .left{ width:100%;}
    .wrap{margin:10px 0;}
    .game-layout{ gap:12px;}
  }
  @media (max-width:620px){
    .wrap{margin:0;}
    .card{padding:10px 5px;}
    .top{gap:6px;}
    .options-list li{font-size:12px;}
    button{font-size:12px;}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top" id="characterCreationPanel">
      <div class="card left">
        <h1>⚔️ Karakter Oluşturucu</h1>
        <div id="stepLabel" class="muted">Adım 1/6: Klan</div>
        <div class="selection-area">
          <ul id="optionsList" class="options-list"></ul>
        </div>
        <div class="panel-row">
          <button id="selectBtn">Seç</button>
          <button id="resetBtn" class="ghost">Sıfırla</button>
        </div>
        <div id="stepResult" class="muted" style="margin-top:10px"></div>
      </div>
      <div class="card right">
        <h1>Karakter Bilgileri</h1>
        <div class="stat-row">
          <div class="stat">Klan: <span id="statClan">-</span></div>
          <div class="stat">Dövüş Stili: <span id="statStyle">-</span></div>
          <div class="stat">Güç: <span id="statGuc">-</span></div>
          <div class="stat">Hız: <span id="statHiz">-</span></div>
          <div class="stat">Karizma: <span id="statKarizma">-</span></div>
          <div class="stat">Can: <span id="statHP">-</span></div>
          <div class="stat">Seviye: <span id="statLevel">1</span></div>
          <div class="stat">EXP: <span id="statExp">0</span></div>
        </div>
        <div class="stat" style="margin-top:12px;">Envanter: <span id="inventory">Boş</span></div>
        <div class="stat" style="margin-top:8px;">Ekipman: <span id="equipmentDisplay">Boş</span></div>
        <div class="stat" style="margin-top:8px;">Altın: <span id="goldDisplay">0</span></div>
        <div class="game-panel">
          <div id="gameIntro" style="margin-top:12px">
            <p class="muted">Tüm seçimleri bitirince <strong>BÖRSGAME'e Başla</strong> butonu çıkacak.</p>
            <button id="startGameBtn" class="ghost hidden">BÖRSGAME'e Başla</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Main Game Area - Hidden until game starts -->
    <div id="gameContainer" class="game-layout hidden">
        <div id="adventureArea" class="card game-main-area">
            <div id="eventDescription" class="result-card"></div>
            <div class="actions" id="eventActions"></div>
            <div id="gameLog" class="log"></div>
        </div>
        <div id="gameStatsDisplay" class="game-stats-area">
            <h3>Karakter Durumu</h3>
            <div class="stat-row">
                <div class="stat">Klan: <span id="gameStatClan">-</span></div>
                <div class="stat">Dövüş Stili: <span id="gameStatStyle">-</span></div>
                <div class="stat">Güç: <span id="gameStatGuc">-</span></div>
                <div class="stat">Hız: <span id="gameStatHiz">-</span></div>
                <div class="stat">Karizma: <span id="gameStatKarizma">-</span></div>
                <div class="stat">Can: <span id="gameStatHPEl">-</span></div>
                <div class="stat">Seviye: <span id="gameStatLevel">1</span></div>
                <div class="stat">EXP: <span id="gameStatExp">0</span></div>
            </div>
            <div class="inventory-stat">Envanter: <span id="gameInventory">Boş</span></div>
            <div class="inventory-stat">Ekipman: <span id="gameEquipmentDisplay">Boş</span></div>
            <div class="inventory-stat">Altın: <span id="gameGoldDisplay">0</span></div>
            <div class="inventory-stat">Kazanılan Dövüş: <span id="fightsWonDisplay">0</span>/15</div>
            <div class="inventory-stat">Konum: <span id="gameLocationDisplay">-</span></div>
            <div class="inventory-stat">Zaman: <span id="gameTimeDisplay">-</span></div>
            <div class="inventory-stat">Hava: <span id="gameWeatherDisplay">-</span></div>
        </div>
        <div id="finalPanel" class="card hidden">
            <h3>BÖRSGAME Tamamlandı</h3>
            <div id="finalLog" class="log"></div>
            <button id="restartAllBtn">Baştan Başlat</button>
        </div>
    </div>
  </div>
<script>
/* ========== OYUN VERİLERİ ========== */
const clans = [
  {name:"Demiralay", weight:1, bonus:{g:10,h:10,k:10}, guaranteedStyle:null, desc:"Efsanevi klan. Okulun gizli kurucuları."},
  {name:"Taş", weight:10, bonus:{g:3,h:3,k:1}, guaranteedStyle:"Karate", desc:"Sert ve disiplinli savaşçılar."},
  {name:"Karahan", weight:10, bonus:{g:1,h:0,k:5}, guaranteedStyle:null, desc:"Entrikacı ve zeki manipülatörler."},
  {name:"Eşme", weight:20, bonus:{g:2,h:0,k:0}, guaranteedStyle:"Boks", desc:"Sokak dövüşçüleri."},
  {name:"Yağmurcu", weight:20, bonus:{g:1,h:0,k:2}, guaranteedStyle:"Muay Thai", desc:"Mistik dövüş sanatları ustası."},
  {name:"Tulunay", weight:20, bonus:{g:2,h:0,k:0}, guaranteedStyle:null, desc:"Gizemli büyücüler."},
  {name:"Çepe", weight:30, bonus:{g:0,h:0,k:0}, guaranteedStyle:null, desc:"Sıradan öğrenciler."},
  {name:"Aysu", weight:40, bonus:{g:-2,h:-2,k:-2}, guaranteedStyle:null, desc:"Mağduriyet psikolojisi."}
];

const fightingStyles = [
  {name:"Karate", weight:10, bonus:2},
  {name:"Boks", weight:10, bonus:2},
  {name:"Muay Thai", weight:10, bonus:2},
  {name:"Hiçbir Stil", weight:69, bonus:0}
];

const items = [
    {id: "kayip_yuzuk", name: "Kayıp Yüzük", type: "accessory", slot: "accessory1", effect: {g:3, h:3, k:3}, description: "Efsanevi bir gücün kaynağı.", rarity: 1, value: 500},
    {id: "antik_savas_eldivenleri", name: "Antik Savaş Eldivenleri", type: "weapon", slot: "mainHand", effect: {g:2}, description: "Eski savaşçılara ait eldiven.", rarity: 5, value: 150},
    {id: "protein_bari", name: "Protein Barı", type: "consumable", effect: {hp: 15}, description: "Sağlığını güçlendiren bar.", rarity: 25, value: 10},
    {id: "eski_okul_anahtari", name: "Eski Okul Anahtarı", type: "story", effect: {}, description: "Gizli odalara erişim sağlayabilir.", rarity: 15, value: 0},
    {id: "sikitin_sansli_corabi", name: "Sikit'in Şanslı Çorabı", type: "accessory", slot: "accessory2", effect: {h:-1, luck: 5}, description: "Kokulu ama şanslı çorap.", rarity: 8, value: 75},
    {id: "zoktayin_kahve_fincani", name: "Zoktay'ın Kahve Fincanı", type: "consumable", effect: {intelligence: 2}, description: "Zihnini açan özel kahve.", rarity: 12, value: 20},
    {id: "temel_zirh", name: "Temel Zırh", type: "armor", slot: "body", effect: {def: 2}, description: "Basit bir koruma.", rarity: 30, value: 30},
    {id: "tahta_kilic", name: "Tahta Kılıç", type: "weapon", slot: "mainHand", effect: {atk: 3}, description: "Eğitim kılıcı.", rarity: 40, value: 20},
    {id: "bitki_001", name: "Şifalı Bitki", type: "crafting_material", description: "İksir yapımında kullanılır.", rarity: 50, value: 5},
    {id: "su_sisesi_001", name: "Su Şişesi", type: "crafting_material", description: "İksir yapımında kullanılır.", rarity: 50, value: 2},
    {id: "ancient_book_001", name: "Antik Kitap", type: "quest_item", description: "Kütüphanecinin aradığı kitap.", rarity: 0, hidden: true, value: 0},
    {id: "kitap_ayraci_001", name: "Kitap Ayracı", type: "accessory", slot: "accessory1", effect: {k:1}, description: "Zekanı artırır.", rarity: 10, value: 40}
];

const enemyNames = [
    {name: "Yiğit Aysu", minZone: 1, maxZone: 2},
    {name: "Sinirli Yiğit Aysu", minZone: 1, maxZone: 3},
    {name: "Berat'ın Gözcüsü Yiğit Aysu", minZone: 2, maxZone: 3},
    {name: "Kızgın Yiğit Aysu", minZone: 3, maxZone: 4},
    {name: "Berat'ın Sadık Koruması Yiğit Aysu", minZone: 2, maxZone: 4},
    {name: "Çatı Katı Muhafızı Yiğit Aysu", minZone: 3, maxZone: 5},
    {name: "Berat'ın Seçkin Savaşçısı Yiğit Aysu", minZone: 3, maxZone: 5}
];

const enemyFightingStyles = [
    {name: "Sokak", bonus: {atk: 1, def: 0, speed: 2}},
    {name: "Disiplinli", bonus: {atk: 2, def: 1, speed: 0}},
    {name: "Hızlı", bonus: {atk: 0, def: 0, speed: 3}},
    {name: "Savunmacı", bonus: {atk: 0, def: 3, speed: 0}},
    {name: "Acımasız", bonus: {atk: 3, def: -1, speed: 1}}
];

const enemyBehaviors = [
  {name: "Agresif", attackFirstChance: 0.8, canBePersuaded: false},
  {name: "Temkinli", attackFirstChance: 0.3, canBePersuaded: true},
  {name: "İkna Edilebilir", attackFirstChance: 0.1, canBePersuaded: true},
  {name: "Fanatik", attackFirstChance: 0.9, canBePersuaded: false}
];

const worldLocations = {
    "Okul Ana Binası": {
        description: "Okulun kalbi, sınıflar ve kütüphane burada.",
        events: [
            {name: "Sınıf Dövüşü", weight: 60, handler: "startBattle"},
            // {name: "Eşya Bulma", weight: 20, handler: "findItem"}, // KALDIRILDI
            {name: "Dinlenme", weight: 20, handler: "rest"},
            {name: "Kütüphaneciyle Konuş", weight: 10, handler: "startDialogue", dialogueId: "librarian_intro"}
        ],
        connections: ["Okul Bahçesi", "Yeraltı Tünelleri", "Kütüphane", "Kantin"]
    },
    "Okul Bahçesi": {
        description: "Geniş ve açık bir alan, bazen tehlikeli karşılaşmalar olabilir.",
        events: [
            {name: "Açık Alan Dövüşü", weight: 80, handler: "startBattle"},
            // {name: "Eşya Bulma", weight: 20, handler: "findItem"}, // KALDIRILDI
            {name: "Direniş Üyesiyle Tanış", weight: 10, handler: "startDialogue", dialogueId: "resistance_intro"}
        ],
        connections: ["Okul Ana Binası", "Yeraltı Tünelleri", "Çatı Katı"]
    },
    "Yeraltı Tünelleri": {
        description: "Okulun altındaki karanlık ve nemli tüneller. Eski sırlar barındırıyor.",
        events: [
            {name: "Karanlık Dövüş", weight: 70, handler: "startBattle"},
            // {name: "Antik Eşya", weight: 30, handler: "findItem"} // KALDIRILDI
        ],
        connections: ["Okul Ana Binası", "Okul Bahçesi"]
    },
    "Çatı Katı": {
        description: "Okulun en yüksek noktası, rüzgarlı ve tehlikeli. Nadir eşyalar bulunabilir.",
        events: [
            {name: "Güçlü Dövüş", weight: 90, handler: "startBattle"},
            // {name: "Nadir Eşya", weight: 10, handler: "findItem"} // KALDIRILDI
        ],
        connections: ["Okul Bahçesi"]
    },
    "Kütüphane": {
        description: "Sessiz ve bilgi dolu bir yer. Kütüphaneci Zoktay burada bulunur.", // Adı güncellendi
        events: [
            {name: "Kitap Ara", weight: 30, handler: "findItem"}, // Bu olay hala eşya bulabilir, ancak artık bir butonla tetiklenmiyor. Sadece görevler için kullanılabilir.
            {name: "Kütüphaneciyle Konuş", weight: 70, handler: "startDialogue", dialogueId: "librarian_intro"}
        ],
        connections: ["Okul Ana Binası"]
    },
    "Kantin": {
        description: "Öğrencilerin toplandığı gürültülü bir yer. Yemek yiyebilir veya dedikodu dinleyebilirsin.",
        events: [
            {name: "Yemek Ye", weight: 50, handler: "rest"},
            {name: "Dedikodu Dinle", weight: 50, handler: "startDialogue", dialogueId: "cantine_gossip"}
        ],
        connections: ["Okul Ana Binası"]
    },
    "Berat'ın Ofisi": {
        description: "Berat Hoca'nın kişisel ofisi. Buradan geri dönüş yok.",
        events: [
            {name: "Final Boss", weight: 100, handler: "startFinalBoss"}
        ],
        connections: [] // Final konum, bağlantı yok
    }
};

const quests = [
  {
    id: "quest_001",
    name: "Kayıp Kitap",
    description: "Kütüphanede kaybolan eski bir kitabı bul.",
    giver: "Kütüphaneci Zoktay", // Adı güncellendi
    location: "Kütüphane",
    objective: { type: "findItem", itemId: "ancient_book_001", count: 1 },
    rewards: { exp: 50, item: "kitap_ayraci_001", gold: 20 },
    status: "available", // available, active, completed, failed
    dialogue: {
      start: "Ah, o eski kitap... Onu bulursan sana iyi bir ödül veririm.",
      progress: "Kitabı buldun mu?",
      complete: "Harika! İşte ödülün.",
      fail: "Kitap bulunamadı, belki başka zaman."
    }
  },
  {
    id: "quest_002",
    name: "Berat'ın Casusu",
    description: "Berat Hoca'nın casuslarından birini etkisiz hale getir.",
    giver: "Direniş Lideri",
    location: "Okul Bahçesi",
    objective: { type: "defeatEnemy", enemyName: "Berat'ın Gözcüsü Yiğit Aysu", count: 1 }, // Düşman adı güncellendi
    rewards: { exp: 75, reputation: { resistance: 10 }, gold: 30 },
    status: "available",
    dialogue: {
      start: "Berat'ın gözcüleri her yerde. Birini durdurmalıyız.",
      progress: "Casusu hallettin mi?",
      complete: "Mükemmel! Direniş sana minnettar.",
      fail: "Casus kaçtı, dikkatli olmalıyız."
    }
  }
];

const questTemplates = [
    {
        type: "fetch",
        name: "Kayıp Eşya Avı",
        description: "Bölgedeki kayıp bir eşyayı bul.",
        objective: { type: "findItem", itemId: null, count: 1 },
        rewards: { exp: 30, gold: 15 }
    },
    {
        type: "eliminate",
        name: "Tehlikeli Düşman",
        description: "Bölgedeki bir düşmanı etkisiz hale getir.",
        objective: { type: "defeatEnemy", enemyName: null, count: 1 },
        rewards: { exp: 40, gold: 20 }
    }
];

const craftingRecipes = [
  {
    id: "healing_potion_recipe",
    name: "İyileştirme İksiri",
    output: { itemId: "protein_bari", count: 1 },
    ingredients: [
      { itemId: "bitki_001", count: 2 },
      { itemId: "su_sisesi_001", count: 1 }
    ]
  }
];

const dialogues = {
    "librarian_intro": [
        { speaker: "Kütüphaneci Zoktay", text: "Merhaba genç adam/hanım. Okulun kütüphanesine hoş geldin.", options: [{ text: "Merhaba.", next: 1 }, { text: "Ne işin var burada?", next: 2 }] },
        { speaker: "Kütüphaneci Zoktay", text: (player) => { // Dinamik metin için fonksiyon
            if (player.k >= 5) {
                return "Ah, ne kadar da hoş bir öğrenci! Sana nasıl yardımcı olabilirim?";
            } else {
                return "Sana nasıl yardımcı olabilirim?";
            }
        }, options: [{ text: "Görev var mı?", action: () => acceptQuest("quest_001") }, { text: "Hiçbir şey.", next: "end" }] },
        { speaker: "Kütüphaneci Zoktay", text: "Burası benim evim gibi. Sen kimsin?", options: [{ text: "Ben bir öğrenciyim.", next: 1 }, { text: "Seni ilgilendirmez.", next: "end" }] }
    ],
    "quest_001_start": [
        { speaker: "Kütüphaneci Zoktay", text: quests.find(q => q.id === "quest_001").dialogue.start, options: [{ text: "Kabul ediyorum.", action: () => acceptQuest("quest_001") }, { text: "Şimdi değil.", next: "end" }] }
    ],
    "resistance_intro": [
        { speaker: "Direniş Üyesi", text: "Psikolojik baskıdan bıktın mı? Berat Hoca'ya karşı durmak ister misin?", options: [{ text: "Evet!", action: () => startDialogue("quest_002_start") }, { text: "Hayır, beni ilgilendirmez.", next: "end" }] }
    ],
    "quest_002_start": [
        { speaker: "Direniş Üyesi", text: quests.find(q => q.id === "quest_002").dialogue.start, options: [{ text: "Kabul ediyorum.", action: () => acceptQuest("quest_002") }, { text: "Şimdi değil.", next: "end" }] }
    ],
    "cantine_gossip": [
        { speaker: "Kantin Görevlisi", text: "Bugün ne alırsın? Yoksa sadece dedikodu mu dinleyeceksin?", options: [{ text: "Dedikodu.", next: 1 }, { text: "Yemek.", action: () => restEvent(), next: "end" }] },
        { speaker: "Kantin Görevlisi", text: "Duydun mu? Berat Hoca'nın yeni bir gözcüsü varmış, yeraltı tünellerinde takılıyormuş. Adı da Yiğit Aysu'ymuş.", options: [{ text: "İlginç.", next: "end" }] } // Diyalog güncellendi
    ]
};

// NPC'ler ve rutinleri
const npcs = [
    {
        id: "librarian_zoktay", // ID güncellendi
        name: "Kütüphaneci Zoktay", // Adı güncellendi
        currentLocation: "Kütüphane",
        routine: [
            { time: "day", location: "Kütüphane", action: "work" },
            { time: "night", location: "Okul Ana Binası", action: "rest" }
        ]
    },
    {
        id: "berat_guard_01",
        name: "Berat'ın Gözcüsü",
        currentLocation: "Okul Ana Binası",
        routine: [
            { time: "day", location: "Okul Ana Binası", action: "patrol" },
            { time: "night", location: "Yeraltı Tünelleri", action: "patrol" }
        ]
    }
];


/* ========== UI REFS ========== */
const characterCreationPanel = document.getElementById("characterCreationPanel");
const selectBtn = document.getElementById("selectBtn");
const resetBtn = document.getElementById("resetBtn");
const stepLabel = document.getElementById("stepLabel");
const stepResult = document.getElementById("stepResult");
const optionsList = document.getElementById("optionsList");

const statClanEl = document.getElementById("statClan");
const statGucEl = document.getElementById("statGuc");
const statHizEl = document.getElementById("statHiz");
const statKarizmaEl = document.getElementById("statKarizma");
const statStyleEl = document.getElementById("statStyle");
const statHPEl = document.getElementById("statHP");
const statLevel = document.getElementById("statLevel");
const statExp = document.getElementById("statExp");
const inventoryEl = document.getElementById("inventory");
const equipmentDisplayEl = document.getElementById("equipmentDisplay");
const goldDisplayEl = document.getElementById("goldDisplay");

const gameContainer = document.getElementById("gameContainer");
const gameStatsDisplay = document.getElementById("gameStatsDisplay");
const gameStatClanEl = document.getElementById("gameStatClan");
const gameStatStyleEl = document.getElementById("gameStatStyle");
const gameStatGucEl = document.getElementById("gameStatGuc");
const gameStatHizEl = document.getElementById("gameStatHiz");
const gameStatKarizmaEl = document.getElementById("gameStatKarizma");
const gameStatHPEl = document.getElementById("gameStatHPEl"); // Düzeltildi
const gameStatLevel = document.getElementById("gameStatLevel");
const gameStatExp = document.getElementById("statExp");
const gameInventoryEl = document.getElementById("gameInventory");
const gameEquipmentDisplayEl = document.getElementById("gameEquipmentDisplay");
const gameGoldDisplayEl = document.getElementById("gameGoldDisplay");
const fightsWonDisplay = document.getElementById("fightsWonDisplay");
const gameLocationDisplayEl = document.getElementById("gameLocationDisplay");
const gameTimeDisplayEl = document.getElementById("gameTimeDisplay");
const gameWeatherDisplayEl = document.getElementById("gameWeatherDisplay");


const startGameBtn = document.getElementById("startGameBtn");
const adventureArea = document.getElementById("adventureArea");
const eventDescriptionDiv = document.getElementById("eventDescription");
const eventActionsDiv = document.getElementById("eventActions");
const gameLog = document.getElementById("gameLog");

const finalPanel = document.getElementById("finalPanel");
const finalLog = document.getElementById("finalLog");
const restartAllBtn = document.getElementById("restartAllBtn");

/* ========== GAME STATE ========== */
const steps = ["klan","guc","hiz","karizma","hp","dovusStili"];
let currentStepIndex = 0;
let currentOptions = [];
let selecting = false;
let selectedClan=null, selectedGuc=null, selectedHiz=null, selectedKarizma=null, selectedHP=null, selectedStyle=null;

let player = {
  g:0,h:0,k:0, style:null,
  level:1, exp:0,
  HP:0, maxHP:0,
  inventory:[],
  equipment: {
    mainHand: null,
    offHand: null,
    head: null,
    body: null,
    legs: null,
    feet: null,
    accessory1: null,
    accessory2: null
  },
  specialAbilities: [
    { id: "guclu_vurus", name: "Güçlü Vuruş", cooldown: 3, currentCooldown: 0, effect: { damageMultiplier: 1.5, cost: 5 } },
    { id: "hizli_kacis", name: "Hızlı Kaçış", cooldown: 5, currentCooldown: 0, effect: { escapeChanceBonus: 0.2, cost: 3 } }
  ],
  activeQuests: [],
  completedQuests: [],
  reputation: {
    resistance: 0,
    berat_faction: 0
  },
  gold: 0,
  currentLocation: "Okul Ana Binası",
  timeOfDay: "day", // day, night
  weather: "clear", // clear, rain, snow
  timeCounter: 0, // Zaman döngüsü için sayaç
  actionsTaken: 0 // Oyuncunun yaptığı hareket sayısı
};

let currentEnemy = null;
let consecutiveEscapes = 0;
let fightsWon = 0;
let currentZone = 1; // Zone can be tied to player level or progress

let originalSelectBtnOnClick = null;
let currentDialogueState = {
    dialogueId: null,
    currentLineIndex: 0,
    currentDialogueData: null
};

let lastGameLoopTime = 0; // Ana oyun döngüsü için zaman damgası
let currentView = "characterCreation"; // 'characterCreation', 'location', 'inventory', 'quests', 'crafting', 'battle', 'dialogue'
let isPlayerTurn = true; // Oyuncu sırası mı?


/* ========== YENİ AI VE DİNAMİK SİSTEMLER ========== */

// Düşman AI Sınıfı
class EnemyAI {
    constructor(enemyInstance, playerInstance) {
        this.enemy = enemyInstance;
        this.player = playerInstance;
        this.currentState = "IDLE"; // IDLE, ATTACKING, FLEEING, PURSUING
        this.target = playerInstance;
        this.actionCooldown = 1000; // AI'ın karar verme sıklığı (ms)
        this.lastActionTime = 0;
    }

    update(deltaTime) {
        this.lastActionTime += deltaTime;
        if (this.lastActionTime < this.actionCooldown) {
            return; // Henüz aksiyon zamanı değil
        }
        this.lastActionTime = 0;

        // Durum geçiş mantığı
        if (this.enemy.HP / this.enemy.maxHP < 0.3 && this.currentState !== "FLEEING") {
            this.currentState = "FLEEING";
            gameLogInsert(`👹 ${this.enemy.name} canı azaldı, kaçmaya çalışıyor!`);
        } else if (this.currentState === "FLEEING" && this.enemy.HP / this.enemy.maxHP >= 0.7) {
            this.currentState = "IDLE"; // Canı iyileşirse geri dönebilir
            gameLogInsert(`👹 ${this.enemy.name} toparlandı.`);
        } else if (this.currentState === "IDLE" && this.isPlayerNearby()) {
            this.currentState = "ATTACKING";
            gameLogInsert(`👹 ${this.enemy.name} seni fark etti!`);
        } else if (this.currentState === "ATTACKING" && !this.isPlayerNearby()) {
            this.currentState = "IDLE"; // Oyuncu uzaklaşırsa
            gameLogInsert(`👹 ${this.enemy.name} seni kaybetti.`);
        }

        // Mevcut duruma göre aksiyon al
        switch (this.currentState) {
            case "IDLE":
                // Düşman boşta, bir şey yapmıyor
                break;
            case "ATTACKING":
                // Düşman saldırıyor (savaş modunda bu zaten yönetiliyor)
                // Burada sadece savaş dışı bir durumda oyuncuya yaklaşma mantığı olabilir
                break;
            case "FLEEING":
                // Düşman kaçıyor (savaş modunda bu zaten yönetiliyor)
                break;
            case "PURSUING":
                // Düşman oyuncuyu takip ediyor
                break;
        }
    }

    isPlayerNearby() {
        // Basit bir kontrol: Eğer savaş aktifse, oyuncu yakındadır.
        // Daha karmaşık bir sistemde, düşmanın konumu ve oyuncunun konumu karşılaştırılır.
        return currentEnemy === this.enemy; // Sadece aktif düşman için geçerli
    }
}

// NPC Rutinlerini Güncelleme
function updateNPCs() {
    const currentTime = player.timeOfDay;
    npcs.forEach(npc => {
        const currentRoutine = npc.routine.find(r => r.time === currentTime);
        if (currentRoutine && npc.currentLocation !== currentRoutine.location) {
            const oldLocation = npc.currentLocation;
            npc.currentLocation = currentRoutine.location;
            gameLogInsert(`🚶 ${npc.name} ${oldLocation} konumundan ${currentRoutine.location} konumuna gitti.`);
        }
    });
}

// Dinamik Görev Oluşturma
function generateDynamicQuest() {
    const template = questTemplates[Math.floor(Math.random() * questTemplates.length)];
    const newQuest = JSON.parse(JSON.stringify(template)); // Şablonu kopyala

    newQuest.id = `dynamic_quest_${Date.now()}`; // Benzersiz ID
    newQuest.status = "available";
    newQuest.giver = "Gizemli Yabancı"; // Veya dinamik olarak bir NPC ata

    // Rastgele bir konum seç
    const locations = Object.keys(worldLocations).filter(loc => worldLocations[loc].connections.length > 0);
    newQuest.location = locations[Math.floor(Math.random() * locations.length)];

    if (newQuest.type === "fetch") {
        const randomItem = items[Math.floor(Math.random() * items.length)];
        newQuest.objective.itemId = randomItem.id;
        newQuest.name = `Kayıp ${randomItem.name} Avı`;
        newQuest.description = `${newQuest.location} bölgesinde kayıp ${randomItem.name}'i bul.`;
    } else if (newQuest.type === "eliminate") {
        const randomEnemyName = enemyNames[Math.floor(Math.random() * enemyNames.length)].name;
        newQuest.objective.enemyName = randomEnemyName;
        newQuest.name = `${randomEnemyName} Avı`;
        newQuest.description = `${newQuest.location} bölgesindeki ${randomEnemyName}'i yen.`;
    }

    // Oluşturulan görevi global görev listesine ekle
    quests.push(newQuest);
    gameLogInsert(`📜 Yeni bir dinamik görev ortaya çıktı: "${newQuest.name}" (${newQuest.location})`);
    return newQuest;
}

// Yetenek Cooldown'larını Azaltma
function decreaseAbilityCooldowns(deltaTime) {
    player.specialAbilities.forEach(ability => {
        if (ability.currentCooldown > 0) {
            ability.currentCooldown -= deltaTime / 1000; // Saniyeye çevir
            if (ability.currentCooldown < 0) ability.currentCooldown = 0;
        }
    });
}

/* ========== TEMEL FONKSİYONLAR ========== */
function pickWeightedIndex(arr){
  const total = arr.reduce((s,x)=>s+(x.weight||0),0);
  if (total === 0) return -1;
  let r = Math.random()*total;
  for(let i=0;i<arr.length;i++){
    if(r < (arr[i].weight||0)) return i;
    r -= (arr[i].weight||0);
  }
  return arr.length-1;
}

function getOptionsForStep(step){
  if(step === "klan"){
    return clans.map(c=>({label:c.name, value:c, weight:c.weight}));
  } else if(step === "dovusStili"){
    return fightingStyles.map(s=>({label:s.name, value:s, weight:s.weight}));
  } else if(step === "hp" || step === "guc" || step === "hiz" || step === "karizma"){
    return statSegments();
  } else {
    return [];
  }
}

function statSegments(){
  return [
    {label:"1", value:1, weight:20}, {label:"2", value:2, weight:18},
    {label:"3", value:3, weight:15}, {label:"4", value:4, weight:12},
    {label:"5", value:5, weight:10}, {label:"6", value:6, weight:8},
    {label:"7", value:7, weight:6},  {label:"8", value:8, weight:5},
    {label:"9", value:9, weight:4},  {label:"10",value:10,weight:2}
  ];
}

function renderOptions(options){
  optionsList.innerHTML = "";
  const totalWeight = options.reduce((sum, opt) => sum + (opt.weight || 0), 0);

  if (options.length === 0) {
      optionsList.innerHTML = "<li>Seçenek bulunamadı.</li>";
      return;
  }

  options.forEach(opt => {
    const li = document.createElement("li");
    const probability = totalWeight > 0 ? ((opt.weight / totalWeight) * 100).toFixed(1) : 0;
    li.innerHTML = `<span>${opt.label}</span> <span class="probability">${probability}%</span>`;
    li.dataset.value = JSON.stringify(opt.value);
    optionsList.appendChild(li);
  });
}

function animateSelection(selectedIndex, callback){
  const items = Array.from(optionsList.children);
  if (items.length === 0 || selectedIndex === -1) {
      callback();
      return;
  }

  let currentIndex = 0;
  let animationCount = 0;
  const maxAnimations = items.length * 3;

  const interval = setInterval(() => {
    if (animationCount >= maxAnimations + selectedIndex) {
      clearInterval(interval);
      items.forEach(item => item.classList.remove("highlight"));
      if (selectedIndex !== -1) {
        items[selectedIndex].classList.add("highlight");
      }
      setTimeout(callback, 500);
      return;
    }

    items.forEach(item => item.classList.remove("highlight"));
    items[currentIndex].classList.add("highlight");

    currentIndex = (currentIndex + 1) % items.length;
    animationCount++;
  }, 80);
}

function handleSelection(seg, isGuaranteed = false){
  const step = steps[currentStepIndex];
  let resultText = "";

  if(step === "klan"){
    selectedClan = seg.value;
    statClanEl.textContent = selectedClan.name;
    resultText = `Klan: ${selectedClan.name}`;
  } else if(step === "guc"){
    selectedGuc = seg.value;
    statGucEl.textContent = selectedGuc;
    resultText = `Güç: ${selectedGuc}`;
  } else if(step === "hiz"){
    selectedHiz = seg.value;
    statHizEl.textContent = selectedHiz;
    resultText = `Hız: ${selectedHiz}`;
  } else if(step === "karizma"){
    selectedKarizma = seg.value;
    statKarizmaEl.textContent = selectedKarizma;
    resultText = `Karizma: ${selectedKarizma}`;
  } else if(step === "hp"){
    selectedHP = seg.value;
    statHPEl.textContent = selectedHP;
    resultText = `Başlangıç Can: ${selectedHP}`;
  }
  else if(step === "dovusStili"){
    selectedStyle = seg.value;
    statStyleEl.textContent = selectedStyle.name;
    resultText = `Dövüş Stili: ${selectedStyle.name}`;
  }
  
  stepResult.textContent = isGuaranteed ? `Garanti: ${resultText}` : resultText;

  currentStepIndex++;
  if(currentStepIndex < steps.length){
    setTimeout(updateStep, 1000);
  } else {
    setTimeout(finalizeCreation, 1000);
  }
}

function updateStep(){
  const step = steps[currentStepIndex];
  const labels = {
    klan:"Adım 1/6: Klan",
    guc:"Adım 2/6: Güç",
    hiz:"Adım 3/6: Hız",
    karizma:"Adım 4/6: Karizma",
    hp:"Adım 5/6: Başlangıç Can",
    dovusStili:"Adım 6/6: Dövüş Stili"
  };
  stepLabel.textContent = labels[step] || "—";
  stepResult.textContent = "";
  selectBtn.disabled = false;
  selecting = false;

  if(step === "dovusStili" && selectedClan && selectedClan.guaranteedStyle){
    const gs = fightingStyles.find(s=> s.name === selectedClan.guaranteedStyle);
    if(gs){
      selectBtn.disabled = true;
      selecting = true;
      const options = getOptionsForStep(step);
      const guaranteedIndex = options.findIndex(opt => opt.value.name === gs.name);
      if (guaranteedIndex !== -1) {
        renderOptions(options);
        animateSelection(guaranteedIndex, () => handleSelection({value: gs}, true));
      } else {
        currentOptions = getOptionsForStep(step);
        renderOptions(currentOptions);
        selectBtn.disabled = false;
        selecting = false;
      }
      return;
    }
  }

  currentOptions = getOptionsForStep(step);
  renderOptions(currentOptions);
}

function finalizeCreation(){
  if(!selectedStyle) {
    const defaultStyleIndex = pickWeightedIndex(fightingStyles);
    selectedStyle = fightingStyles[defaultStyleIndex !== -1 ? defaultStyleIndex : 0];
  }
  
  player.g = (selectedGuc || 1) + (selectedClan?.bonus?.g || 0) + (selectedStyle?.bonus || 0);
  player.h = (selectedHiz || 1) + (selectedClan?.bonus?.h || 0);
  player.k = (selectedKarizma || 1) + (selectedClan?.bonus?.k || 0);
  player.style = selectedStyle?.name || "Yok";
  player.level = 1; player.exp = 0;
  player.maxHP = 10 + (selectedHP || 0) + Math.floor((player.g + player.h + player.k)/3);
  player.HP = player.maxHP;

  updatePlayerStatsUI();

  stepLabel.textContent = "Oluşturma Tamamlandı";
  stepResult.textContent = "Karakter hazır — BÖRSGAME'e başla!";
  selectBtn.disabled = true;
  startGameBtn.classList.remove("hidden");
  startGameBtn.addEventListener("click", startGame, {once:true});
}

function calculatePlayerStats() {
  let totalG = (selectedGuc || 1) + (selectedClan?.bonus?.g || 0) + (selectedStyle?.bonus || 0);
  let totalH = (selectedHiz || 1) + (selectedClan?.bonus?.h || 0);
  let totalK = (selectedKarizma || 1) + (selectedClan?.bonus?.k || 0);
  let totalHPBonus = 0;

  // Ekipman bonuslarını ekle
  for (const slot in player.equipment) {
    const item = player.equipment[slot];
    if (item) {
      if (item.effect.g) totalG += item.effect.g;
      if (item.effect.h) totalH += item.effect.h;
      if (item.effect.k) totalK += item.effect.k;
      if (item.effect.hp) totalHPBonus += item.effect.hp;
    }
  }
  
  // Envanterdeki kalıcı eşya bonuslarını ekle (Sikit'in Şanslı Çorabı gibi)
  player.inventory.forEach(item => {
      if (item.type === "permanent") { // "permanent" type for items like "Sikit'in Şanslı Çorabı"
          if (item.effect.g) totalG += item.effect.g;
          if (item.effect.h) totalH += item.effect.h;
          if (item.effect.k) totalK += item.effect.k;
      }
  });

  player.g = totalG;
  player.h = totalH;
  player.k = totalK;
  player.maxHP = 10 + (selectedHP || 0) + Math.floor((player.g + player.h + player.k)/3) + totalHPBonus;
  // HP'nin maxHP'yi geçmemesini sağla
  player.HP = Math.min(player.HP, player.maxHP);
}


function updatePlayerStatsUI(){
    calculatePlayerStats(); // Her UI güncellemesinde statları yeniden hesapla

    statGucEl.textContent = player.g;
    statHizEl.textContent = player.h;
    statKarizmaEl.textContent = player.k;
    statClanEl.textContent = selectedClan ? selectedClan.name : "Bilinmiyor";
    statStyleEl.textContent = player.style;
    statHPEl.textContent = `${player.HP}/${player.maxHP}`;
    statLevel.textContent = player.level;
    statExp.textContent = player.exp;
    goldDisplayEl.textContent = player.gold;

    gameStatClanEl.textContent = selectedClan ? selectedClan.name : "Bilinmiyor";
    gameStatStyleEl.textContent = player.style;
    gameStatGucEl.textContent = player.g;
    gameStatHizEl.textContent = player.h;
    gameStatKarizmaEl.textContent = player.k;
    gameStatHPEl.textContent = `${player.HP}/${player.maxHP}`;
    gameStatLevel.textContent = player.level;
    gameStatExp.textContent = player.exp;
    gameGoldDisplayEl.textContent = player.gold;
    gameLocationDisplayEl.textContent = player.currentLocation;
    gameTimeDisplayEl.textContent = player.timeOfDay === "day" ? "Gündüz" : "Gece";
    gameWeatherDisplayEl.textContent = player.weather === "clear" ? "Açık" : player.weather === "rain" ? "Yağmurlu" : "Karlı";
    
    updateInventoryUI();
    updateEquipmentUI();
    updateFightsWonDisplay();
}

function updateInventoryUI(){
    if (player.inventory.length === 0) {
        inventoryEl.textContent = "Boş";
        gameInventoryEl.textContent = "Boş";
    } else {
        const inventoryNames = player.inventory.map(item => item.name).join(", ");
        inventoryEl.textContent = inventoryNames;
        gameInventoryEl.textContent = inventoryNames;
    }
}

function updateEquipmentUI(){
    let equippedItems = [];
    for (const slot in player.equipment) {
        if (player.equipment[slot]) {
            equippedItems.push(`${player.equipment[slot].name} (${slot})`);
        }
    }
    if (equippedItems.length === 0) {
        equipmentDisplayEl.textContent = "Boş";
        gameEquipmentDisplayEl.textContent = "Boş";
    } else {
        equipmentDisplayEl.textContent = equippedItems.join(", ");
        gameEquipmentDisplayEl.textContent = equippedItems.join(", ");
    }
}

function updateFightsWonDisplay(){
    fightsWonDisplay.textContent = `${fightsWon}/15`;
}

function gameLogInsert(txt){
    const d=document.createElement("div");
    d.innerHTML = txt;
    gameLog.appendChild(d);
    gameLog.scrollTop = gameLog.scrollHeight;
}

/* ========== OYUN DÖNGÜSÜ VE MEKANİKLER ========== */

// Ana Oyun Döngüsü (Artık zamanı otomatik ilerletmiyor)
function gameLoop(currentTime) {
    // Bu fonksiyon artık zamanı otomatik ilerletmiyor.
    // Sadece yetenek cooldown'larını ve düşman AI'ını güncelliyor.
    // Zaman ilerlemesi handlePlayerAction() içinde yönetiliyor.

    if (gameContainer.classList.contains("hidden") || finalPanel.classList.contains("hidden") === false) {
        requestAnimationFrame(gameLoop);
        return;
    }

    // Düşman AI'ını güncelle (sadece savaş aktifse)
    if (currentEnemy && currentEnemy.ai) {
        currentEnemy.ai.update(0); // DeltaTime'ı burada kullanmıyoruz, AI kendi iç zamanlamasını yönetebilir
    }

    // Yetenek cooldown'larını azalt (her frame'de)
    const deltaTime = currentTime - lastGameLoopTime;
    if (lastGameLoopTime !== 0) { // İlk çağrıda deltaTime 0 olmasın
        decreaseAbilityCooldowns(deltaTime);
    }
    lastGameLoopTime = currentTime;

    // UI güncellemeleri (sadece savaş sırasında veya statlar değiştiğinde)
    // updatePlayerStatsUI(); // Bu artık her hareket sonrası çağrılıyor

    requestAnimationFrame(gameLoop);
}


function startGame(){
  characterCreationPanel.classList.add("hidden");
  gameContainer.classList.remove("hidden");

  document.getElementById("gameIntro").classList.add("hidden");
  gameLog.innerHTML = "";
  fightsWon = 0;
  currentZone = 1;
  player.currentLocation = "Okul Ana Binası"; // Başlangıç konumu
  player.timeOfDay = "day";
  player.weather = "clear";
  player.timeCounter = 0; // Zaman sayacını sıfırla
  player.actionsTaken = 0; // Aksiyon sayacını sıfırla
  
  gameLogInsert("📖 BÖRSGAME: Açık Dünya Hikayesi");
  gameLogInsert("Okulun kapısından her gün aynı şekilde giriyorsun ama bu sefer farklı. Koridorların, bahçenin, tünellerin hepsinin ardında görünmeyen bir düzen var. Herkes aynı şeye fısıldıyor: “Bu okulun gerçek sahibi ders anlatan hocalar değil… Berat Hoca.”");
  gameLogInsert("Berat Hoca sıradan bir öğretmen gibi görünse de aslında okulun gölgesinde büyüyen bir örgütün lideri. Dersler, sınavlar, teneffüsler… bunların hepsi sadece bir maske. Perde arkasında o, öğrenciler üzerinde psikolojik bir ağ örüyor. Sadık korumaları, gizli tuzakları, kendi düzeni var. Amacı basit: okuldaki herkesi kontrol altına almak.");
  gameLogInsert("Sen ise sıradan bir öğrencisin. Hiçbir ayrıcalığın yok, kimse seni kurtarmayacak. Ama içinde susmayan bir dürtü var: özgürlük.");
  gameLogInsert("Arkadaşların korkudan sessiz kalıyor, bazıları ise Berat Hoca’nın düzenine katılıp güç uğruna ona hizmet ediyor. Sen ise bu oyunda tarafsız kalamazsın.");
  gameLogInsert("Okulda gideceğin her yol seni farklı bir yola sürükleyecek...");
  
  updatePlayerStatsUI();
  
  renderLocationActions();

  // Ana oyun döngüsünü başlat
  lastGameLoopTime = 0;
  requestAnimationFrame(gameLoop);
}

function handlePlayerAction() {
    player.actionsTaken++;
    if (player.actionsTaken >= 5) { // Her 5 harekette bir zaman geçsin
        updateTimeAndWeather();
        player.actionsTaken = 0;
    }
    updatePlayerStatsUI(); // UI'ı her hareket sonrası güncelle
}

function renderLocationActions(){
  currentView = "location"; // Görünümü ana konum olarak ayarla
  eventActionsDiv.innerHTML = "";
  eventDescriptionDiv.innerHTML = `<h3>🌍 Keşif Modu - ${player.currentLocation}</h3><p>Nereye gitmek istersin?</p>`;
  
  const currentLocationData = worldLocations[player.currentLocation];
  
  // Konum bağlantılarını göster
  currentLocationData.connections.forEach(connectedLoc => {
    const btn = document.createElement("button");
    btn.textContent = `Git: ${connectedLoc}`;
    btn.onclick = () => {
        changeLocation(connectedLoc);
        handlePlayerAction(); // Her hareket sonrası zamanı kontrol et
    };
    eventActionsDiv.appendChild(btn);
  });

  // Konuma özel olayları göster
  currentLocationData.events.forEach(event => {
      const btn = document.createElement("button");
      btn.textContent = event.name;
      btn.onclick = () => {
          handleLocationEvent(event);
          handlePlayerAction(); // Her hareket sonrası zamanı kontrol et
      };
      eventActionsDiv.appendChild(btn);
  });

  // Rastgele keşfet butonu
  const exploreBtn = document.createElement("button");
  exploreBtn.textContent = "Rastgele Keşfet";
  exploreBtn.onclick = () => {
      exploreRandomEvent();
      handlePlayerAction(); // Her hareket sonrası zamanı kontrol et
  };
  eventActionsDiv.appendChild(exploreBtn);

  // Menü butonlarını ayrı bir satırda veya gruplandırılmış olarak göster
  const menuButtonsContainer = document.createElement("div");
  menuButtonsContainer.style.display = "flex";
  menuButtonsContainer.style.gap = "8px";
  menuButtonsContainer.style.marginTop = "10px";
  menuButtonsContainer.style.justifyContent = "center"; // Menü butonlarını ortala

  const inventoryBtn = document.createElement("button");
  inventoryBtn.textContent = "Envanter";
  inventoryBtn.onclick = () => openInventory();
  menuButtonsContainer.appendChild(inventoryBtn);

  const questLogBtn = document.createElement("button");
  questLogBtn.textContent = "Görevler";
  questLogBtn.onclick = () => openQuestLog();
  menuButtonsContainer.appendChild(questLogBtn);

  const craftingBtn = document.createElement("button");
  craftingBtn.textContent = "Zanaat";
  craftingBtn.onclick = () => openCraftingMenu();
  menuButtonsContainer.appendChild(craftingBtn);

  eventActionsDiv.appendChild(menuButtonsContainer);
}

function changeLocation(newLocation) {
    gameLogInsert(`🚶 ${newLocation} konumuna geçtin...`);
    player.currentLocation = newLocation;
    // updateTimeAndWeather(); // Zaman ve hava durumu artık ana döngüde güncelleniyor
    updatePlayerStatsUI(); // Konum değiştiğinde UI'ı güncelle
    renderLocationActions();
}

function handleLocationEvent(event) {
    gameLogInsert(`⚡ ${event.name} olayı gerçekleşti!`);
    setTimeout(() => {
        if (event.handler === "startBattle") {
            encounterEnemy();
        } else if (event.handler === "startFinalBoss") {
            startFinalBoss();
        } else if (event.handler === "findItem") {
            findItem();
        } else if (event.handler === "rest") {
            restEvent();
        } else if (event.handler === "startDialogue") {
            startDialogue(event.dialogueId);
        } else {
            gameLogInsert("Bilinmeyen olay türü. Keşif devam ediyor...");
            renderLocationActions();
        }
    }, 800);
}

function exploreRandomEvent() {
    const currentLocationData = worldLocations[player.currentLocation];
    const events = currentLocationData.events;
    if (events && events.length > 0) {
        const eventIndex = pickWeightedIndex(events);
        if (eventIndex !== -1) {
            handleLocationEvent(events[eventIndex]);
            return;
        }
    }
    gameLogInsert("Bu konumda rastgele keşfedilecek bir şey bulunamadı.");
    renderLocationActions();
}

function updateTimeAndWeather() {
    // Basit bir gündüz/gece döngüsü
    player.timeOfDay = (player.timeOfDay === "day") ? "night" : "day";
    gameLogInsert(`⏰ Zaman: ${player.timeOfDay === "day" ? "Gündüz" : "Gece"}`);

    // Hava durumu rastgele değişebilir
    const weatherOptions = ["clear", "rain", "snow"];
    player.weather = weatherOptions[Math.floor(Math.random() * weatherOptions.length)];
    gameLogInsert(`☁️ Hava Durumu: ${player.weather === "clear" ? "Açık" : player.weather === "rain" ? "Yağmurlu" : "Karlı"}`);

    // Hava durumuna göre ek olaylar
    if (player.weather === "rain") {
        gameLogInsert("🌧️ Yağmur görüşü kısıtlıyor, düşmanlar seni daha zor fark edebilir.");
        // Düşmanların algı menzilini geçici olarak azaltma gibi bir mekanik eklenebilir
    } else if (player.weather === "snow") {
        gameLogInsert("❄️ Kar fırtınası başladı, hareket etmek zorlaşıyor.");
        // Oyuncunun hızını geçici olarak azaltma gibi bir mekanik eklenebilir
    }
    updateNPCs(); // NPC'leri de zamanla güncelle
    if (Math.random() < 0.3) { // %30 şansla yeni dinamik görev
        generateDynamicQuest();
    }
}

function generateEnemy(zone, isBoss = false) {
  const zoneScale = [0, 0.6, 1.0, 1.6, 2.3, 3.0];
  const scale = zoneScale[Math.min(zone, zoneScale.length - 1)];
  
  let atk, def, hp, name;

  if (isBoss) {
    name = "Berat Hoca (Final Boss)";
    atk = Math.max(12, Math.floor(18 + scale * 6));
    def = Math.max(6, Math.floor(12 + scale * 4));
    hp = Math.max(60, Math.floor(80 + scale * 25));
  } else {
    let enemyPool = enemyNames.filter(e => zone >= e.minZone && zone <= e.maxZone);
    if (enemyPool.length === 0) enemyPool = enemyNames;
    
    const selectedEnemy = enemyPool[Math.floor(Math.random() * enemyPool.length)];
    name = selectedEnemy.name; // Burası zaten güncel enemyNames'i kullanacak
    
    atk = Math.max(2, Math.floor(3 + scale * 2.5));
    def = Math.max(1, Math.floor(2 + scale * 1.5));
    hp = Math.max(8, Math.floor(12 + scale * 6));

    const randomStyle = enemyFightingStyles[Math.floor(Math.random() * enemyFightingStyles.length)];
    // name = `${randomStyle.name} ${name}`; // Bu satırı kaldırın veya yorum satırı yapın
    // Artık enemyNames içinde zaten "Hızlı Tekme Yiğit Aysu" gibi isimler var.
    // Eğer "Hızlı Tekme" gibi ön ekleri stil olarak eklemek isterseniz, bu satırı bırakabilirsiniz.
    atk += (randomStyle.bonus.atk || 0);
    def += (randomStyle.bonus.def || 0);
    hp += (randomStyle.bonus.speed || 0);
  }

  const behavior = enemyBehaviors[Math.floor(Math.random() * enemyBehaviors.length)];
  
  const enemy = {name, atk, def, HP: hp, maxHP: hp, zone, behavior, isBoss};
  enemy.ai = new EnemyAI(enemy, player); // Düşmana AI objesi ata
  return enemy;
}

function encounterEnemy() {
  currentEnemy = generateEnemy(currentZone);
  currentView = "battle";
  
  eventDescriptionDiv.innerHTML = `
    <strong>⚔️ Bölge ${currentZone} - Karşında: ${currentEnemy.name}</strong>
    <p>Can: <span class="enemy-hp">${currentEnemy.HP}/${currentEnemy.maxHP}</span></p>
    <p>Saldırı: ${currentEnemy.atk} • Savunma: ${currentEnemy.def}</p>
  `;

  gameLogInsert(`⚡ ${currentEnemy.name} ile karşılaştın!`);

  if (Math.random() < currentEnemy.behavior.attackFirstChance) {
    gameLogInsert(`${currentEnemy.name} seni hemen saldırdı!`);
    setTimeout(() => {
      const enemyDamage = calculateDamage(currentEnemy.atk, player.g);
      player.HP -= enemyDamage;
      gameLogInsert(`${currentEnemy.name} seni vurdu! ${enemyDamage} hasar aldın. (Can: ${player.HP}/${player.maxHP})`);
      updatePlayerStatsUI();
      
      if (player.HP <= 0) {
        onPlayerDefeated();
      } else {
        isPlayerTurn = true; // Düşman ilk saldırdıysa sıra oyuncuya geçer
        renderBattleActions();
      }
    }, 1200);
  } else {
    isPlayerTurn = true; // Oyuncu ilk başlar
    showEnemyEncounterOptions();
  }
}

function showEnemyEncounterOptions() {
  currentView = "battle";
  eventActionsDiv.innerHTML = "";

  const attackBtn = document.createElement("button");
  attackBtn.textContent = "⚔️ Saldır";
  attackBtn.onclick = () => startBattle();

  const runBtn = document.createElement("button");
  runBtn.textContent = "🏃 Kaç";
  runBtn.classList.add("ghost");
  runBtn.onclick = () => attemptEscape();

  const talkBtn = document.createElement("button");
  talkBtn.textContent = "💬 Konuş";
  talkBtn.classList.add("ghost");
  talkBtn.onclick = () => attemptNegotiation();

  eventActionsDiv.appendChild(attackBtn);
  eventActionsDiv.appendChild(runBtn);
  eventActionsDiv.appendChild(talkBtn);
}

function startBattle() {
  currentView = "battle";
  eventDescriptionDiv.innerHTML = `
    <strong>⚔️ SAVAŞ BAŞLADI!</strong>
    <div>🛡️ Sen: ${player.HP}/${player.maxHP} Can</div>
    <div>👹 ${currentEnemy.name}: ${currentEnemy.HP}/${currentEnemy.maxHP} Can</div>
  `;
  
  gameLogInsert(`⚔️ ${currentEnemy.name} ile dövüş başladı!`);
  isPlayerTurn = true; // Dövüş başladığında sıra oyuncuda
  renderBattleActions();
}

function renderBattleActions() {
  currentView = "battle";
  eventActionsDiv.innerHTML = "";
  
  const attackBtn = document.createElement("button");
  attackBtn.textContent = "👊 Saldır";
  attackBtn.onclick = () => performAttack();

  const escapeBtn = document.createElement("button");
  escapeBtn.textContent = "🏃 Kaç";
  escapeBtn.classList.add("ghost");
  escapeBtn.onclick = () => attemptEscape();

  // Yetenek butonlarını ekle
  player.specialAbilities.forEach(ability => {
      const abilityBtn = document.createElement("button");
      abilityBtn.textContent = `${ability.name} (${ability.currentCooldown > 0 ? Math.ceil(ability.currentCooldown) + "s" : "Hazır"})`;
      abilityBtn.disabled = ability.currentCooldown > 0 || player.HP < ability.effect.cost || !isPlayerTurn; // Oyuncu sırası değilse yetenek kullanılamaz
      abilityBtn.onclick = () => useAbility(ability);
      eventActionsDiv.appendChild(abilityBtn);
  });

  eventActionsDiv.appendChild(attackBtn);
  eventActionsDiv.appendChild(escapeBtn);
}

function calculateDamage(attackerStat, defenderStat) {
  const baseDamage = Math.max(1, Math.floor(attackerStat * 0.6));
  const defenseReduction = Math.max(0, Math.floor(defenderStat * 0.3));
  const variance = Math.floor(Math.random() * 3) - 1;
  return Math.max(1, baseDamage - defenseReduction + variance);
}

function performAttack() {
  if (!currentEnemy || !isPlayerTurn) return; // Sadece oyuncu sırasıysa saldır
  
  disableEventActions(true); // Butonları devre dışı bırak
  
  const playerDamage = calculateDamage(player.g, currentEnemy.def);
  currentEnemy.HP -= playerDamage;
  
  gameLogInsert(`⚔️ ${currentEnemy.name}'e ${playerDamage} hasar verdin!`);
  
  updateBattleDisplay();
  
  if (currentEnemy.HP <= 0) {
    setTimeout(() => onEnemyDefeated(), 800);
  } else {
    isPlayerTurn = false; // Sırayı düşmana geçir
    setTimeout(enemyTurn, 1200);
  }
}

function useAbility(ability) {
    if (ability.currentCooldown > 0 || player.HP < ability.effect.cost || !isPlayerTurn) return; // Sadece oyuncu sırasıysa yetenek kullan

    disableEventActions(true); // Butonları devre dışı bırak

    player.HP -= ability.effect.cost; // Yetenek maliyeti
    ability.currentCooldown = ability.cooldown; // Cooldown başlat

    gameLogInsert(`✨ ${ability.name} yeteneğini kullandın!`);

    if (ability.id === "guclu_vurus") {
        const playerDamage = calculateDamage(player.g * ability.effect.damageMultiplier, currentEnemy.def);
        currentEnemy.HP -= playerDamage;
        gameLogInsert(`💥 Güçlü vuruşla ${currentEnemy.name}'e ${playerDamage} hasar verdin!`);
    } else if (ability.id === "hizli_kacis") {
        // Kaçış şansını artır
        attemptEscape(ability.effect.escapeChanceBonus);
        return; // Kaçış denemesi sonrası düşman sırası gelmesin
    }

    updatePlayerStatsUI();
    updateBattleDisplay();

    if (currentEnemy.HP <= 0) {
        setTimeout(() => onEnemyDefeated(), 800);
    } else {
        isPlayerTurn = false; // Sırayı düşmana geçir
        setTimeout(enemyTurn, 1200);
    }
}

function enemyTurn() {
  if (!currentEnemy || currentEnemy.HP <= 0) return;
  
  const enemyDamage = calculateDamage(currentEnemy.atk, player.g);
  player.HP -= enemyDamage;
  
  gameLogInsert(`👹 ${currentEnemy.name} saldırdı ve ${enemyDamage} hasar aldın!`);
  
  updatePlayerStatsUI();
  updateBattleDisplay();
  
  if (player.HP <= 0) {
    setTimeout(() => onPlayerDefeated(), 800);
  } else {
    isPlayerTurn = true; // Sırayı oyuncuya geçir
    setTimeout(() => disableEventActions(false), 1000); // Butonları tekrar etkinleştir
  }
}

function updateBattleDisplay() {
  eventDescriptionDiv.innerHTML = `
    <strong>⚔️ SAVAŞ DEVAM EDİYOR</strong>
    <div>🛡️ Sen: <span class="player-hp">${player.HP}/${player.maxHP}</span> Can</div>
    <div>👹 ${currentEnemy.name}: <span class="enemy-hp">${currentEnemy.HP}/${currentEnemy.maxHP}</span> Can</div>
  `;
  renderBattleActions(); // Yetenek cooldown'ları güncellendiğinde butonları yenile
}

function attemptEscape(bonusChance = 0) {
  disableEventActions(true);
  
  const escapeChance = Math.min(0.8, (player.h / (player.h + currentEnemy.atk)) + 0.2 + bonusChance);
  const success = Math.random() < escapeChance;
  
  if (success) {
    consecutiveEscapes = 0;
    gameLogInsert(`🏃 Başarıyla kaçtın!`);
    currentEnemy = null;
    isPlayerTurn = true; // Kaçış başarılıysa sıra oyuncuya geçer
    setTimeout(() => renderLocationActions(), 1000);
  } else {
    consecutiveEscapes++;
    gameLogInsert("🏃 Kaçış başarısız! Düşman seni yakaladı!");
    isPlayerTurn = false; // Kaçış başarısızsa sıra düşmana geçer
    setTimeout(enemyTurn, 800);
  }
}

function attemptNegotiation() {
  disableEventActions(true);
  
  if (!currentEnemy.behavior.canBePersuaded) {
    gameLogInsert(`💬 ${currentEnemy.name} konuşmaya ilgisiz!`);
    isPlayerTurn = false; // Müzakere başarısızsa sıra düşmana geçer
    setTimeout(enemyTurn, 800);
    return;
  }
  
  const persuasionChance = Math.min(0.7, player.k / (player.k + currentEnemy.atk));
  const success = Math.random() < persuasionChance;
  
  if (success) {
    gameLogInsert(`💬 ${currentEnemy.name} ile anlaşmaya vardın!`);
    
    const expGain = Math.floor(currentEnemy.maxHP * 0.3);
    player.exp += expGain;
    gameLogInsert(`🕊️ Barışçıl çözüm bonusu: +${expGain} EXP`);
    
    currentEnemy = null;
    updatePlayerStatsUI();
    isPlayerTurn = true; // Anlaşma başarılıysa sıra oyuncuya geçer
    setTimeout(() => renderLocationActions(), 1200);
  } else {
    gameLogInsert(`💬 Müzakere başarısız! ${currentEnemy.name} daha da öfkelendi!`);
    currentEnemy.atk += 1;
    isPlayerTurn = false; // Müzakere başarısızsa sıra düşmana geçer
    setTimeout(enemyTurn, 800);
  }
}

function onEnemyDefeated() {
  if (!currentEnemy) return;
  
  consecutiveEscapes = 0;
  fightsWon++;
  
  let expGain = 15 + (currentZone * 3);
  if (currentEnemy.isBoss) expGain = Math.floor(expGain * 3);
  
  player.exp += expGain;
  gameLogInsert(`🏆 ${currentEnemy.name} yenildi! +${expGain} EXP kazandın!`);
  
  // Düşmandan altın düşürme
  const goldDrop = Math.floor(Math.random() * (currentEnemy.zone * 5 + 5)); // Zone'a göre altın düşürme
  player.gold += goldDrop;
  gameLogInsert(`💰 ${goldDrop} altın buldun!`);

  updatePlayerStatsUI();
  updateFightsWonDisplay();
  
  // Görev kontrolü - Düşman yenme görevi
  player.activeQuests.forEach(questId => {
      const quest = quests.find(q => q.id === questId);
      if (quest && quest.objective.type === "defeatEnemy" && quest.objective.enemyName === currentEnemy.name) {
          completeQuest(questId);
      }
  });

  if (currentEnemy.isBoss) {
    gameLogInsert("🎉 BÖRSGAME tamamlandı! Berat Hoca'yı yendin!");
    setTimeout(() => endGame(true), 2000);
    return;
  }
  
  currentEnemy = null;
  isPlayerTurn = true; // Düşman yenildiğinde sıra oyuncuya geçer
  if (Math.random() < 0.4) {
    setTimeout(findItem, 1000);
  } else {
    setTimeout(checkLevelUp, 800);
  }
}

function onPlayerDefeated() {
  gameLogInsert("💀 Yenildin... Hikaye burada sona eriyor.");
  endGame(false);
}

function checkLevelUp() {
  if (player.exp >= player.level * 35) {
    player.level++;
    player.exp = 0;
    
    const hpBonus = 8;
    const statBonus = 1;
    
    player.maxHP += hpBonus;
    player.HP = player.maxHP;
    player.g += statBonus; // Güç otomatik artıyor, diğer statlar için seçim eklenebilir
    
    gameLogInsert(`🆙 SEVİYE ATLADIN! Lv.${player.level}`);
    gameLogInsert(`📈 Max Can +${hpBonus}, Güç +${statBonus}, tam iyileştirme!`);
    
    updatePlayerStatsUI();
  }
  
  setTimeout(() => renderLocationActions(), 1200);
}

function findItem() {
  const itemIndex = pickWeightedIndex(items.map(item => ({...item, weight: 1/item.rarity})));
  const item = items[itemIndex];
  
  if (!item) {
    gameLogInsert("🔍 Aradın ama bir şey bulamadın.");
    setTimeout(() => renderLocationActions(), 800);
    return;
  }
  
  gameLogInsert(`🎁 ${item.name} buldun!`);
  addItemToInventory(item);
  
  // Görev kontrolü - Eşya bulma görevi
  player.activeQuests.forEach(questId => {
      const quest = quests.find(q => q.id === questId);
      if (quest && quest.objective.type === "findItem" && player.inventory.some(invItem => invItem.id === quest.objective.itemId)) {
          completeQuest(questId);
      }
  });

  setTimeout(() => renderLocationActions(), 1200);
}

function addItemToInventory(item) {
  player.inventory.push(item);
  gameLogInsert(`📋 Envanterine ${item.name} eklendi.`);
  updatePlayerStatsUI(); // Envanter değiştiğinde UI'ı güncelle
}

function restEvent() {
  const restAmount = Math.floor(player.maxHP * 0.4);
  player.HP = Math.min(player.maxHP, player.HP + restAmount);
  
  eventDescriptionDiv.innerHTML = `<h4>😴 Dinlenme Alanı</h4><p>Huzurlu bir yerde dinlendin. Güçlerin tazelendi.</p>`;
  
  gameLogInsert(`😴 Dinlendin ve ${restAmount} Can kazandın.`);
  updatePlayerStatsUI();
  
  const continueBtn = document.createElement("button");
  continueBtn.textContent = "Devam Et";
  continueBtn.onclick = () => renderLocationActions();
  
  eventActionsDiv.innerHTML = "";
  eventActionsDiv.appendChild(continueBtn);
}

function startFinalBoss() {
  gameLogInsert("🏛️ Berat Hoca'nın ofisine ulaştın...");
  gameLogInsert("👑 Final savaş başlamak üzere!");
  gameLogInsert("Bu yol uzun, karanlık ve zorlu. Ama artık sen sıradan bir öğrenci değilsin!");
  
  setTimeout(() => {
    currentEnemy = generateEnemy(currentZone, true);
    startBattle();
  }, 1500);
}

function disableEventActions(disabled) {
  const buttons = eventActionsDiv.querySelectorAll("button");
  buttons.forEach(btn => btn.disabled = !!disabled);
}

function endGame(victory) {
  adventureArea.classList.add("hidden");
  gameStatsDisplay.classList.add("hidden");
  finalPanel.classList.remove("hidden");
  
  finalLog.innerHTML = "";
  
  if (victory) {
    finalLog.innerHTML += `<div><h3>🎉 BÖRSGAME TAMAMLANDI!</h3></div>`;
    finalLog.innerHTML += `<div>Berat Hoca'yı yendin ve okulun karanlık sırlarını açığa çıkardın! Okulda yeni bir düzen doğdu. Öğrenciler korkudan kurtuldu.</div>`;
    finalLog.innerHTML += `<div style="margin-top:12px;"><strong>📊 Final İstatistiklerin:</strong></div>`;
    finalLog.innerHTML += `<div>• Seviye: ${player.level}</div>`;
    finalLog.innerHTML += `<div>• Kazanılan Dövüş: ${fightsWon}</div>`;
    finalLog.innerHTML += `<div>• Final Güç: ${player.g}</div>`;
    finalLog.innerHTML += `<div>• Final Hız: ${player.h}</div>`;
    finalLog.innerHTML += `<div>• Final Karizma: ${player.k}</div>`;
    finalLog.innerHTML += `<div>• Toplam Altın: ${player.gold}</div>`;
  } else {
    finalLog.innerHTML += `<div><h3>💀 OYUN BİTTİ</h3></div>`;
    finalLog.innerHTML += `<div>Yenildin... Berat Hoca'nın adı bir efsane gibi yıllarca yankılanacak ve sen sadece unutulmuş bir öğrenci olacaksın.</div>`;
    finalLog.innerHTML += `<div style="margin-top:12px;">Ulaştığın seviye: ${player.level}</div>`;
    finalLog.innerHTML += `<div>Kazanılan dövüş: ${fightsWon}</div>`;
    finalLog.innerHTML += `<div>Topladığın Altın: ${player.gold}</div>`;
  }
}

/* ========== YENİ MEKANİKLER ========== */

// Envanter Yönetimi
function openInventory() {
    currentView = "inventory";
    eventDescriptionDiv.innerHTML = `<h3>🎒 Envanter</h3>`;
    eventActionsDiv.innerHTML = "";

    if (player.inventory.length === 0) {
        eventActionsDiv.innerHTML = "<p>Envanterin boş.</p>";
    } else {
        player.inventory.forEach(item => {
            const itemDiv = document.createElement("div");
            itemDiv.classList.add("inventory-item");
            itemDiv.innerHTML = `<span>${item.name} (${item.description})</span>`;
            
            const actionsDiv = document.createElement("div");
            actionsDiv.classList.add("inventory-item-actions");

            if (item.type === "consumable") {
                const useBtn = document.createElement("button");
                useBtn.textContent = "Kullan";
                useBtn.onclick = () => useItem(item);
                actionsDiv.appendChild(useBtn);
            } else if (item.type === "weapon" || item.type === "armor" || item.type === "accessory") {
                const equipBtn = document.createElement("button");
                equipBtn.textContent = "Kuşan";
                equipBtn.onclick = () => equipItem(item);
                actionsDiv.appendChild(equipBtn);
            }
            
            const sellBtn = document.createElement("button");
            sellBtn.textContent = `Sat (${item.value} Altın)`;
            sellBtn.onclick = () => sellItem(item);
            actionsDiv.appendChild(sellBtn);

            itemDiv.appendChild(actionsDiv);
            eventActionsDiv.appendChild(itemDiv);
        });
    }
    
    const backBtn = document.createElement("button");
    backBtn.textContent = "Geri";
    backBtn.onclick = () => renderLocationActions();
    eventActionsDiv.appendChild(backBtn);
}

function useItem(item) {
    if (item.type === "consumable") {
        if (item.effect.hp) {
            player.HP = Math.min(player.maxHP, player.HP + item.effect.hp);
            gameLogInsert(`💚 ${item.name} kullanıldı. Can +${item.effect.hp}`);
        }
        // Diğer consumable etkileri buraya eklenebilir (örn: stat bonusları)
        player.inventory = player.inventory.filter(i => i !== item); // Envanterden kaldır
    } else {
        gameLogInsert(`${item.name} şu an kullanılamaz.`);
    }
    updatePlayerStatsUI();
    openInventory(); // Envanteri yeniden render et
}

function equipItem(item) {
    if (!item.slot) {
        gameLogInsert(`${item.name} kuşanılabilir bir eşya değil.`);
        return;
    }

    // Önceki ekipmanı envantere geri koy
    if (player.equipment[item.slot]) {
        player.inventory.push(player.equipment[item.slot]);
        gameLogInsert(`${player.equipment[item.slot].name} envantere geri konuldu.`);
    }
    // Yeni ekipmanı kuşan
    player.equipment[item.slot] = item;
    // Envanterden kaldır
    player.inventory = player.inventory.filter(i => i !== item);
    gameLogInsert(`${item.name} kuşanıldı.`);
    updatePlayerStatsUI(); // Statüleri ve UI'ı yeniden hesapla/güncelle
    openInventory(); // Menüyü yenile
}

function sellItem(item) {
    if (item.value > 0) {
        player.gold += item.value;
        player.inventory = player.inventory.filter(i => i !== item);
        gameLogInsert(`${item.name} ${item.value} altına satıldı.`);
        updatePlayerStatsUI();
        openInventory();
    } else {
        gameLogInsert(`${item.name} satılamaz.`);
    }
}

// Görev Sistemi
function openQuestLog() {
    currentView = "quests";
    eventDescriptionDiv.innerHTML = `<h3>📜 Görevler</h3>`;
    eventActionsDiv.innerHTML = "";

    if (player.activeQuests.length === 0 && player.completedQuests.length === 0) {
        eventActionsDiv.innerHTML = "<p>Aktif veya tamamlanmış görevin yok.</p>";
    } else {
        if (player.activeQuests.length > 0) {
            eventActionsDiv.innerHTML += "<h4>Aktif Görevler:</h4>";
            player.activeQuests.forEach(questId => {
                const quest = quests.find(q => q.id === questId);
                if (quest) {
                    const questDiv = document.createElement("div");
                    questDiv.classList.add("quest-item");
                    questDiv.innerHTML = `<span><strong>${quest.name}</strong>: ${quest.description}</span>`;
                    eventActionsDiv.appendChild(questDiv);
                }
            });
        }
        if (player.completedQuests.length > 0) {
            eventActionsDiv.innerHTML += "<h4>Tamamlanmış Görevler:</h4>";
            player.completedQuests.forEach(questId => {
                const quest = quests.find(q => q.id === questId);
                if (quest) {
                    const questDiv = document.createElement("div");
                    questDiv.classList.add("quest-item");
                    questDiv.innerHTML = `<span><strong>${quest.name}</strong>: ${quest.description} (Tamamlandı)</span>`;
                    eventActionsDiv.appendChild(questDiv);
                }
            });
        }
    }
    
    const backBtn = document.createElement("button");
    backBtn.textContent = "Geri";
    backBtn.onclick = () => renderLocationActions();
    eventActionsDiv.appendChild(backBtn);
}

function acceptQuest(questId) {
    const quest = quests.find(q => q.id === questId);
    if (quest && quest.status === "available" && !player.activeQuests.includes(questId)) {
        quest.status = "active";
        player.activeQuests.push(questId);
        gameLogInsert(`Yeni görev: "${quest.name}" kabul edildi!`);
    } else {
        gameLogInsert(`"${quest.name}" görevi zaten aktif veya kabul edilemez.`);
    }
}

function completeQuest(questId) {
    const quest = quests.find(q => q.id === questId);
    if (quest && quest.status === "active" && player.activeQuests.includes(questId)) {
        // Görev hedefini kontrol et
        let objectiveMet = false;
        if (quest.objective.type === "findItem") {
            objectiveMet = player.inventory.some(invItem => invItem.id === quest.objective.itemId);
        } else if (quest.objective.type === "defeatEnemy") {
            objectiveMet = true; // Bu kısım, düşman yenildiğinde zaten tetikleniyor
        }

        if (objectiveMet) {
            quest.status = "completed";
            player.activeQuests = player.activeQuests.filter(id => id !== questId);
            player.completedQuests.push(questId);
            gameLogInsert(`Görev "${quest.name}" tamamlandı!`);
            
            // Ödülleri ver
            if (quest.rewards.exp) player.exp += quest.rewards.exp;
            if (quest.rewards.item) {
                const rewardItem = items.find(i => i.id === quest.rewards.item);
                if (rewardItem) addItemToInventory(rewardItem);
            }
            if (quest.rewards.gold) player.gold += quest.rewards.gold;
            if (quest.rewards.reputation) {
                for (const faction in quest.rewards.reputation) {
                    if (player.reputation[faction] !== undefined) {
                        player.reputation[faction] += quest.rewards.reputation[faction];
                        gameLogInsert(`${faction} ile itibarın ${quest.rewards.reputation[faction]} arttı.`);
                    }
                }
            }
            updatePlayerStatsUI();
        } else {
            gameLogInsert(`Görev "${quest.name}" henüz tamamlanmadı. Hedefler karşılanmadı.`);
        }
    }
}

// Diyalog Sistemi
function startDialogue(dialogueId) {
    currentView = "dialogue";
    currentDialogueState.dialogueId = dialogueId;
    currentDialogueState.currentLineIndex = 0;
    currentDialogueState.currentDialogueData = dialogues[dialogueId];

    if (!currentDialogueState.currentDialogueData) {
        gameLogInsert("Diyalog bulunamadı.");
        renderLocationActions();
        return;
    }
    showDialogueLine();
}

function showDialogueLine() {
    const line = currentDialogueState.currentDialogueData[currentDialogueState.currentLineIndex];

    if (!line) {
        renderLocationActions(); // Diyalog bittiğinde normal aksiyonlara dön
        return;
    }

    // Eğer metin bir fonksiyon ise, player objesini argüman olarak vererek çağır
    const dialogueText = typeof line.text === 'function' ? line.text(player) : line.text;

    eventDescriptionDiv.innerHTML = `<h4>💬 ${line.speaker}</h4><p>${dialogueText}</p>`;
    eventActionsDiv.innerHTML = "";

    line.options.forEach(option => {
        const btn = document.createElement("button");
        btn.textContent = option.text;
        btn.onclick = () => {
            if (option.action) {
                option.action(); // Özel bir aksiyon varsa çalıştır (örn: acceptQuest)
            }
            if (option.next === "end") {
                renderLocationActions();
            } else if (typeof option.next === 'number') {
                currentDialogueState.currentLineIndex = option.next;
                showDialogueLine();
            } else if (typeof option.next === 'string') { // Yeni bir diyalog akışına geçiş
                startDialogue(option.next); // Yeni diyalog ID'si ile başlat
            } else {
                currentDialogueState.currentLineIndex++;
                showDialogueLine();
            }
        };
        eventActionsDiv.appendChild(btn);
    });
}

// Zanaat Sistemi
function openCraftingMenu() {
    currentView = "crafting";
    eventDescriptionDiv.innerHTML = `<h3>🛠️ Zanaat Menüsü</h3>`;
    eventActionsDiv.innerHTML = "";

    if (craftingRecipes.length === 0) {
        eventActionsDiv.innerHTML = "<p>Üretilebilecek tarif yok.</p>";
    } else {
        craftingRecipes.forEach(recipe => {
            const recipeDiv = document.createElement("div");
            recipeDiv.classList.add("inventory-item"); // Stil için aynı sınıfı kullan
            
            const ingredientsText = recipe.ingredients.map(ing => {
                const item = items.find(i => i.id === ing.itemId);
                return `${ing.count}x ${item ? item.name : 'Bilinmeyen Öğe'}`;
            }).join(", ");

            const outputItem = items.find(i => i.id === recipe.output.itemId);
            const outputText = `${recipe.output.count}x ${outputItem ? outputItem.name : 'Bilinmeyen Öğe'}`;

            recipeDiv.innerHTML = `<span><strong>${recipe.name}</strong>: ${outputText} (Gerekenler: ${ingredientsText})</span>`;
            
            const craftBtn = document.createElement("button");
            craftBtn.textContent = "Üret";
            craftBtn.disabled = !canCraft(recipe);
            craftBtn.onclick = () => craftItem(recipe);
            recipeDiv.appendChild(craftBtn);
            eventActionsDiv.appendChild(recipeDiv);
        });
    }

    const backBtn = document.createElement("button");
    backBtn.textContent = "Geri";
    backBtn.onclick = () => renderLocationActions();
    eventActionsDiv.appendChild(backBtn);
}

function canCraft(recipe) {
    return recipe.ingredients.every(ing => {
        const playerHas = player.inventory.filter(item => item.id === ing.itemId).length;
        return playerHas >= ing.count;
    });
}

function craftItem(recipe) {
    if (canCraft(recipe)) {
        // Malzemeleri envanterden çıkar
        recipe.ingredients.forEach(ing => {
            for (let i = 0; i < ing.count; i++) {
                const index = player.inventory.findIndex(item => item.id === ing.itemId);
                if (index !== -1) {
                    player.inventory.splice(index, 1);
                }
            }
        });
        // Ürünü envantere ekle
        const outputItem = items.find(i => i.id === recipe.output.itemId);
        if (outputItem) {
            for (let i = 0; i < recipe.output.count; i++) {
                player.inventory.push(outputItem);
            }
            gameLogInsert(`${recipe.output.count} adet ${outputItem.name} ürettin!`);
        } else {
            gameLogInsert("Üretim hatası: Çıktı öğesi bulunamadı.");
        }
        
        updatePlayerStatsUI();
        openCraftingMenu(); // Menüyü yenile
    } else {
        gameLogInsert("Yeterli malzemen yok!");
    }
}


/* ========== OYUN BAŞLATMA VE SIFIRLAMA ========== */
function initGame() {
  currentStepIndex = 0;
  currentOptions = [];
  selecting = false;
  selectedClan = null;
  selectedGuc = null; 
  selectedHiz = null;
  selectedKarizma = null;
  selectedHP = null;
  selectedStyle = null;

  player = {
    g: 0, h: 0, k: 0, style: null,
    level: 1, exp: 0,
    HP: 0, maxHP: 0,
    inventory: [],
    equipment: {
      mainHand: null, offHand: null, head: null, body: null, legs: null, feet: null, accessory1: null, accessory2: null
    },
    specialAbilities: [ // Yetenekleri sıfırla
        { id: "guclu_vurus", name: "Güçlü Vuruş", cooldown: 3, currentCooldown: 0, effect: { damageMultiplier: 1.5, cost: 5 } },
        { id: "hizli_kacis", name: "Hızlı Kaçış", cooldown: 5, currentCooldown: 0, effect: { escapeChanceBonus: 0.2, cost: 3 } }
    ],
    activeQuests: [],
    completedQuests: [],
    reputation: { resistance: 0, berat_faction: 0 },
    gold: 0,
    currentLocation: "Okul Ana Binası",
    timeOfDay: "day",
    weather: "clear",
    timeCounter: 0,
    actionsTaken: 0 // Aksiyon sayacını sıfırla
  };
  currentEnemy = null;
  consecutiveEscapes = 0;
  fightsWon = 0;
  currentZone = 1;
  isPlayerTurn = true; // Oyun sıfırlandığında sıra oyuncuda başlar

  // NPC'lerin konumlarını başlangıç durumuna getir
  npcs.forEach(npc => {
      const initialRoutine = npc.routine.find(r => r.time === "day"); // Varsayılan olarak gündüz konumuna
      if (initialRoutine) {
          npc.currentLocation = initialRoutine.location;
      }
  });

  // Görevleri sıfırla (dinamik görevler de dahil)
  // Sadece başlangıçtaki statik görevleri tut
  const initialQuests = [
    {
      id: "quest_001",
      name: "Kayıp Kitap",
      description: "Kütüphanede kaybolan eski bir kitabı bul.",
      giver: "Kütüphaneci Zoktay", // Adı güncellendi
      location: "Kütüphane",
      objective: { type: "findItem", itemId: "ancient_book_001", count: 1 },
      rewards: { exp: 50, item: "kitap_ayraci_001", gold: 20 },
      status: "available",
      dialogue: {
        start: "Ah, o eski kitap... Onu bulursan sana iyi bir ödül veririm.",
        progress: "Kitabı buldun mu?",
        complete: "Harika! İşte ödülün.",
        fail: "Kitap bulunamadı, belki başka zaman."
      }
    },
    {
      id: "quest_002",
      name: "Berat'ın Casusu",
      description: "Berat Hoca'nın casuslarından birini etkisiz hale getir.",
      giver: "Direniş Lideri",
      location: "Okul Bahçesi",
      objective: { type: "defeatEnemy", enemyName: "Berat'ın Gözcüsü Yiğit Aysu", count: 1 }, // Düşman adı güncellendi
      rewards: { exp: 75, reputation: { resistance: 10 }, gold: 30 },
      status: "available",
      dialogue: {
        start: "Berat'ın gözcüleri her yerde. Birini durdurmalıyız.",
        progress: "Casusu hallettin mi?",
        complete: "Mükemmel! Direniş sana minnettar.",
        fail: "Casus kaçtı, dikkatli olmalıyım."
      }
    }
  ];
  quests.splice(0, quests.length, ...initialQuests); // Global quests dizisini sıfırla

  statClanEl.textContent = "-";
  statGucEl.textContent = "-";
  statHizEl.textContent = "-";
  statKarizmaEl.textContent = "-";
  statStyleEl.textContent = "-";
  statHPEl.textContent = "-";
  statLevel.textContent = "1";
  statExp.textContent = "0";
  inventoryEl.textContent = "Boş";
  equipmentDisplayEl.textContent = "Boş";
  goldDisplayEl.textContent = "0";

  gameStatClanEl.textContent = "-";
  gameStatGucEl.textContent = "-";
  gameStatHizEl.textContent = "-";
  gameStatKarizmaEl.textContent = "-";
  gameStatStyleEl.textContent = "-";
  gameStatHPEl.textContent = "-"; // Düzeltildi
  gameStatLevel.textContent = "1";
  gameStatExp.textContent = "0";
  gameInventoryEl.textContent = "Boş";
  gameEquipmentDisplayEl.textContent = "Boş";
  gameGoldDisplayEl.textContent = "0";
  fightsWonDisplay.textContent = "0/15";
  gameLocationDisplayEl.textContent = "-";
  gameTimeDisplayEl.textContent = "-";
  gameWeatherDisplayEl.textContent = "-";

  characterCreationPanel.classList.remove("hidden");
  gameContainer.classList.add("hidden");
  document.getElementById("gameIntro").classList.remove("hidden");
  finalPanel.classList.add("hidden");
  startGameBtn.classList.add("hidden");

  selectBtn.disabled = false;
  selectBtn.textContent = "Seç";
  
  // Event listener'ı sadece bir kez eklemek için kontrol
  if (!selectBtn.hasAttribute('data-listener-added')) {
      selectBtn.addEventListener("click", originalSelectBtnOnClick);
      selectBtn.setAttribute('data-listener-added', 'true');
  }

  updateStep();
  gameLog.innerHTML = "";
}

originalSelectBtnOnClick = () => {
  if (selecting) return;
  selecting = true;
  selectBtn.disabled = true;
  stepResult.textContent = "";

  const selectedIndex = pickWeightedIndex(currentOptions);
  if (selectedIndex === -1) {
      stepResult.textContent = "Seçim yapılamadı, seçenek yok.";
      selectBtn.disabled = false;
      selecting = false;
      return;
  }
  animateSelection(selectedIndex, () => {
    handleSelection(currentOptions[selectedIndex]);
  });
};

resetBtn.addEventListener("click", initGame);
restartAllBtn.addEventListener("click", initGame);
document.addEventListener("DOMContentLoaded", initGame);

</script>
</body>
</html>
