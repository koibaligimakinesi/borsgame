<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>B√ñRSGAME: Kayƒ±p Klanƒ±n Sƒ±rrƒ± - Geni≈ületilmi≈ü A√ßƒ±k D√ºnya</title>
<style>
  :root{
    --bg:#1a0a2a; 
    --panel:#2b1a3b; 
    --accent:#e0b0ff; 
    --muted:#c2a0d6; 
    --card:#3a2a4a; 
    --border:#4a3a5a; 
    --shadow:rgba(0,0,0,0.3); 
    --button-bg:#6a3a8a; 
    --button-hover:#8a5a9a; 
    --button-ghost:#4a3a5a; 
    --text:#f0e6f5; 
    --danger:#ff6b6b; 
    --success:#6bff6b; 
  }
  body{
    margin:0;
    font-family:Inter,system-ui,Arial;
    background:linear-gradient(180deg,var(--bg),#2a1a3a); 
    color:var(--text);
    padding:0;
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:flex-start;
  }
  .wrap{
    width:min(960px,98vw);
    display:flex;
    flex-direction:column;
    margin:40px 0 40px 0;
    gap:24px;
  }
  .top{
    display:grid;
    grid-template-columns:320px 1fr;
    gap:20px;
    margin-bottom:0;
  }
  .card{
    background:var(--card);
    border-radius:12px;
    box-shadow:0 3px 18px var(--shadow);
    border:1px solid var(--border);
    padding:20px 18px 15px 18px;
    margin-bottom:0;
  }
  .left{ text-align:center; }
  .right{ width:100%; }

  h1{
    margin:0 0 6px 0;
    font-size:20px;
    color:var(--accent);
    font-weight:700;
    letter-spacing:0.02em;
  }
  h3{
    margin:0 0 6px 0;
    font-size:15px;
    color:var(--accent);
    font-weight:600;
  }
  .muted{
    color:var(--muted);
    font-size:13px;
    margin-bottom:5px;
  }
  .panel-row{
    display:flex;
    gap:8px;
    justify-content:center;
    margin-top:8px;
  }
  button{
    appearance:none;
    border:0;
    background:var(--button-bg);
    color:var(--text);
    padding:8px 16px;
    border-radius:8px;
    font-weight:600;
    cursor:pointer;
    font-size:14px;
    transition:background 0.15s, color 0.15s;
    box-shadow:0 2px 8px rgba(0,0,0,0.06);
    outline:none;
  }
  button:hover{ background:var(--button-hover);}
  button.ghost{
    background:var(--button-ghost);
    color:var(--muted);
    border:1px solid var(--border);
  }
  button.ghost:hover{ background:rgba(224,176,255,0.06);} 
  button.danger{ background:var(--danger);}
  button.danger:hover{ background:#ff8b8b;}
  button.success{ background:var(--success);}
  button.success:hover{ background:#8bff8b;}
  .selection-area{
    margin:10px auto 0 auto;
    width:100%;
    min-height:160px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
  }
  .options-list{
    list-style:none;
    padding:0;
    margin:0;
    width:98%;
    max-height:120px;
    overflow-y:auto;
    text-align:left;
  }
  .options-list li{
    padding:6px 10px;
    border-bottom:1px solid var(--border);
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:14px;
    border-radius:5px;
    transition:background 0.16s;
  }
  .options-list li:last-child{ border-bottom:none;}
  .options-list li.highlight{ background:rgba(224,176,255,0.12);} 
  .options-list li .probability{ font-size:12px;color:var(--muted);}
  .stat-row{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:5px;
    margin-top:8px;
    margin-bottom:0;
  }
  .stat{
    background:rgba(255,255,255,0.03);
    padding:6px 9px;
    border-radius:6px;
    font-weight:600;
    color:var(--text);
    font-size:13px;
    margin-bottom:2px;
  }
  .inventory-stat{ margin-top:6px;font-size:12px;}
  .game-panel{ margin-top:12px;}
  .game-layout{
    display:flex;
    flex-direction:column;
    gap:20px;
  }
  .game-main-area{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:0;
    margin-bottom:0;
  }
  .game-stats-area{
    background:var(--panel);
    border-radius:10px;
    border:1px solid var(--border);
    padding:12px;
    margin-top:0;
    margin-bottom:0;
  }
  .log{
    min-height:100px;
    max-height:160px;
    overflow:auto;
    background:rgba(255,255,255,0.015);
    border-radius:7px;
    padding:9px;
    margin-top:9px;
    font-size:12px;
    color:var(--muted);
    scrollbar-width:thin;
  }
  .result-card{
    background:linear-gradient(180deg,var(--panel),#1a0a2a); 
    padding:12px 12px 9px 12px;
    border-radius:9px;
    border:1px solid var(--border);
    margin-top:9px;
    margin-bottom:0;
    color:var(--text);
  }
  .actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin:12px 0 0 0;
    justify-content:center;
  }
  .actions button{
    flex:1 1 120px;
    min-width:100px;
    margin-bottom:4px;
  }
  .player-hp{ color:#ffb0e0;font-weight:600;} 
  .enemy-hp{ color:#e0b0ff;font-weight:600;} 
  .story-text{ line-height:1.5;margin-bottom:12px;}
  .inventory-item, .quest-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    border-bottom: 1px solid var(--border);
    font-size:13px;
  }
  .inventory-item:last-child, .quest-item:last-child { border-bottom: none; }
  .inventory-item-actions button {
    padding: 3px 8px;
    font-size: 11px;
    margin-left: 4px;
  }
  .inventory-item-actions{
    display:flex;
    gap:5px;
  }
  .hidden{ display:none;}
  #gameStatsDisplay .stat-row{ margin-top:0; }
  @media (max-width:900px){
    .top{ display:flex; flex-direction:column; gap:12px;}
    .left{ width:100%;}
    .wrap{margin:10px 0;}
    .game-layout{ gap:12px;}
  }
  @media (max-width:620px){
    .wrap{margin:0;}
    .card{padding:10px 5px;}
    .top{gap:6px;}
    .options-list li{font-size:12px;}
    button{font-size:12px;}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top" id="characterCreationPanel">
      <div class="card left">
        <h1>‚öîÔ∏è Karakter Olu≈üturucu</h1>
        <div id="stepLabel" class="muted">Adƒ±m 1/6: Klan</div>
        <div class="selection-area">
          <ul id="optionsList" class="options-list"></ul>
        </div>
        <div class="panel-row">
          <button id="selectBtn">Se√ß</button>
          <button id="resetBtn" class="ghost">Sƒ±fƒ±rla</button>
        </div>
        <div id="stepResult" class="muted" style="margin-top:10px"></div>
      </div>
      <div class="card right">
        <h1>Karakter Bilgileri</h1>
        <div class="stat-row">
          <div class="stat">Klan: <span id="statClan">-</span></div>
          <div class="stat">D√∂v√º≈ü Stili: <span id="statStyle">-</span></div>
          <div class="stat">G√º√ß: <span id="statGuc">-</span></div>
          <div class="stat">Hƒ±z: <span id="statHiz">-</span></div>
          <div class="stat">Karizma: <span id="statKarizma">-</span></div>
          <div class="stat">Can: <span id="statHP">-</span></div>
          <div class="stat">Seviye: <span id="statLevel">1</span></div>
          <div class="stat">EXP: <span id="statExp">0</span></div>
        </div>
        <div class="stat" style="margin-top:12px;">Envanter: <span id="inventory">Bo≈ü</span></div>
        <div class="stat" style="margin-top:8px;">Ekipman: <span id="equipmentDisplay">Bo≈ü</span></div>
        <div class="stat" style="margin-top:8px;">Altƒ±n: <span id="goldDisplay">0</span></div>
        <div class="game-panel">
          <div id="gameIntro" style="margin-top:12px">
            <p class="muted">T√ºm se√ßimleri bitirince <strong>B√ñRSGAME'e Ba≈üla</strong> butonu √ßƒ±kacak.</p>
            <button id="startGameBtn" class="ghost hidden">B√ñRSGAME'e Ba≈üla</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Main Game Area - Hidden until game starts -->
    <div id="gameContainer" class="game-layout hidden">
        <div id="adventureArea" class="card game-main-area">
            <div id="eventDescription" class="result-card"></div>
            <div class="actions" id="eventActions"></div>
            <div id="gameLog" class="log"></div>
        </div>
        <div id="gameStatsDisplay" class="game-stats-area">
            <h3>Karakter Durumu</h3>
            <div class="stat-row">
                <div class="stat">Klan: <span id="gameStatClan">-</span></div>
                <div class="stat">D√∂v√º≈ü Stili: <span id="gameStatStyle">-</span></div>
                <div class="stat">G√º√ß: <span id="gameStatGuc">-</span></div>
                <div class="stat">Hƒ±z: <span id="gameStatHiz">-</span></div>
                <div class="stat">Karizma: <span id="gameStatKarizma">-</span></div>
                <div class="stat">Can: <span id="gameStatHPEl">-</span></div>
                <div class="stat">Seviye: <span id="gameStatLevel">1</span></div>
                <div class="stat">EXP: <span id="gameStatExp">0</span></div>
            </div>
            <div class="inventory-stat">Envanter: <span id="gameInventory">Bo≈ü</span></div>
            <div class="inventory-stat">Ekipman: <span id="gameEquipmentDisplay">Bo≈ü</span></div>
            <div class="inventory-stat">Altƒ±n: <span id="gameGoldDisplay">0</span></div>
            <div class="inventory-stat">Kazanƒ±lan D√∂v√º≈ü: <span id="fightsWonDisplay">0</span>/15</div>
            <div class="inventory-stat">Konum: <span id="gameLocationDisplay">-</span></div>
            <div class="inventory-stat">Zaman: <span id="gameTimeDisplay">-</span></div>
            <div class="inventory-stat">Hava: <span id="gameWeatherDisplay">-</span></div>
        </div>
        <div id="finalPanel" class="card hidden">
            <h3>B√ñRSGAME Tamamlandƒ±</h3>
            <div id="finalLog" class="log"></div>
            <button id="restartAllBtn">Ba≈ütan Ba≈ülat</button>
        </div>
    </div>
  </div>
<script>
/* ========== OYUN VERƒ∞LERƒ∞ ========== */
const clans = [
  {name:"Demiralay", weight:1, bonus:{g:10,h:10,k:10}, guaranteedStyle:null, desc:"Efsanevi klan. Okulun gizli kurucularƒ±."},
  {name:"Ta≈ü", weight:10, bonus:{g:3,h:3,k:1}, guaranteedStyle:"Karate", desc:"Sert ve disiplinli sava≈ü√ßƒ±lar."},
  {name:"Karahan", weight:10, bonus:{g:1,h:0,k:5}, guaranteedStyle:null, desc:"Entrikacƒ± ve zeki manip√ºlat√∂rler."},
  {name:"E≈üme", weight:20, bonus:{g:2,h:0,k:0}, guaranteedStyle:"Boks", desc:"Sokak d√∂v√º≈ü√ß√ºleri."},
  {name:"Yaƒümurcu", weight:20, bonus:{g:1,h:0,k:2}, guaranteedStyle:"Muay Thai", desc:"Mistik d√∂v√º≈ü sanatlarƒ± ustasƒ±."},
  {name:"Tulunay", weight:20, bonus:{g:2,h:0,k:0}, guaranteedStyle:null, desc:"Gizemli b√ºy√ºc√ºler."},
  {name:"√áepe", weight:30, bonus:{g:0,h:0,k:0}, guaranteedStyle:null, desc:"Sƒ±radan √∂ƒürenciler."},
  {name:"Aysu", weight:40, bonus:{g:-2,h:-2,k:-2}, guaranteedStyle:null, desc:"Maƒüduriyet psikolojisi."}
];

const fightingStyles = [
  {name:"Karate", weight:10, bonus:2},
  {name:"Boks", weight:10, bonus:2},
  {name:"Muay Thai", weight:10, bonus:2},
  {name:"Hi√ßbir Stil", weight:69, bonus:0}
];

const items = [
    {id: "kayip_yuzuk", name: "Kayƒ±p Y√ºz√ºk", type: "accessory", slot: "accessory1", effect: {g:3, h:3, k:3}, description: "Efsanevi bir g√ºc√ºn kaynaƒüƒ±.", rarity: 1, value: 500},
    {id: "antik_savas_eldivenleri", name: "Antik Sava≈ü Eldivenleri", type: "weapon", slot: "mainHand", effect: {g:2}, description: "Eski sava≈ü√ßƒ±lara ait eldiven.", rarity: 5, value: 150},
    {id: "protein_bari", name: "Protein Barƒ±", type: "consumable", effect: {hp: 15}, description: "Saƒülƒ±ƒüƒ±nƒ± g√º√ßlendiren bar.", rarity: 25, value: 10},
    {id: "eski_okul_anahtari", name: "Eski Okul Anahtarƒ±", type: "story", effect: {}, description: "Gizli odalara eri≈üim saƒülayabilir.", rarity: 15, value: 0},
    {id: "sikitin_sansli_corabi", name: "Sikit'in ≈ûanslƒ± √áorabƒ±", type: "accessory", slot: "accessory2", effect: {h:-1, luck: 5}, description: "Kokulu ama ≈üanslƒ± √ßorap.", rarity: 8, value: 75},
    {id: "zoktayin_kahve_fincani", name: "Zoktay'ƒ±n Kahve Fincanƒ±", type: "consumable", effect: {intelligence: 2}, description: "Zihnini a√ßan √∂zel kahve.", rarity: 12, value: 20},
    {id: "temel_zirh", name: "Temel Zƒ±rh", type: "armor", slot: "body", effect: {def: 2}, description: "Basit bir koruma.", rarity: 30, value: 30},
    {id: "tahta_kilic", name: "Tahta Kƒ±lƒ±√ß", type: "weapon", slot: "mainHand", effect: {atk: 3}, description: "Eƒüitim kƒ±lƒ±cƒ±.", rarity: 40, value: 20},
    {id: "bitki_001", name: "≈ûifalƒ± Bitki", type: "crafting_material", description: "ƒ∞ksir yapƒ±mƒ±nda kullanƒ±lƒ±r.", rarity: 50, value: 5},
    {id: "su_sisesi_001", name: "Su ≈ûi≈üesi", type: "crafting_material", description: "ƒ∞ksir yapƒ±mƒ±nda kullanƒ±lƒ±r.", rarity: 50, value: 2},
    {id: "ancient_book_001", name: "Antik Kitap", type: "quest_item", description: "K√ºt√ºphanecinin aradƒ±ƒüƒ± kitap.", rarity: 0, hidden: true, value: 0},
    {id: "kitap_ayraci_001", name: "Kitap Ayracƒ±", type: "accessory", slot: "accessory1", effect: {k:1}, description: "Zekanƒ± artƒ±rƒ±r.", rarity: 10, value: 40}
];

const enemyNames = [
    {name: "Yiƒüit Aysu", minZone: 1, maxZone: 2},
    {name: "Sinirli Yiƒüit Aysu", minZone: 1, maxZone: 3},
    {name: "Berat'ƒ±n G√∂zc√ºs√º Yiƒüit Aysu", minZone: 2, maxZone: 3},
    {name: "Kƒ±zgƒ±n Yiƒüit Aysu", minZone: 3, maxZone: 4},
    {name: "Berat'ƒ±n Sadƒ±k Korumasƒ± Yiƒüit Aysu", minZone: 2, maxZone: 4},
    {name: "√áatƒ± Katƒ± Muhafƒ±zƒ± Yiƒüit Aysu", minZone: 3, maxZone: 5},
    {name: "Berat'ƒ±n Se√ßkin Sava≈ü√ßƒ±sƒ± Yiƒüit Aysu", minZone: 3, maxZone: 5}
];

const enemyFightingStyles = [
    {name: "Sokak", bonus: {atk: 1, def: 0, speed: 2}},
    {name: "Disiplinli", bonus: {atk: 2, def: 1, speed: 0}},
    {name: "Hƒ±zlƒ±", bonus: {atk: 0, def: 0, speed: 3}},
    {name: "Savunmacƒ±", bonus: {atk: 0, def: 3, speed: 0}},
    {name: "Acƒ±masƒ±z", bonus: {atk: 3, def: -1, speed: 1}}
];

const enemyBehaviors = [
  {name: "Agresif", attackFirstChance: 0.8, canBePersuaded: false},
  {name: "Temkinli", attackFirstChance: 0.3, canBePersuaded: true},
  {name: "ƒ∞kna Edilebilir", attackFirstChance: 0.1, canBePersuaded: true},
  {name: "Fanatik", attackFirstChance: 0.9, canBePersuaded: false}
];

const worldLocations = {
    "Okul Ana Binasƒ±": {
        description: "Okulun kalbi, sƒ±nƒ±flar ve k√ºt√ºphane burada.",
        events: [
            {name: "Sƒ±nƒ±f D√∂v√º≈ü√º", weight: 60, handler: "startBattle"},
            // {name: "E≈üya Bulma", weight: 20, handler: "findItem"}, // KALDIRILDI
            {name: "Dinlenme", weight: 20, handler: "rest"},
            {name: "K√ºt√ºphaneciyle Konu≈ü", weight: 10, handler: "startDialogue", dialogueId: "librarian_intro"}
        ],
        connections: ["Okul Bah√ßesi", "Yeraltƒ± T√ºnelleri", "K√ºt√ºphane", "Kantin"]
    },
    "Okul Bah√ßesi": {
        description: "Geni≈ü ve a√ßƒ±k bir alan, bazen tehlikeli kar≈üƒ±la≈ümalar olabilir.",
        events: [
            {name: "A√ßƒ±k Alan D√∂v√º≈ü√º", weight: 80, handler: "startBattle"},
            // {name: "E≈üya Bulma", weight: 20, handler: "findItem"}, // KALDIRILDI
            {name: "Direni≈ü √úyesiyle Tanƒ±≈ü", weight: 10, handler: "startDialogue", dialogueId: "resistance_intro"}
        ],
        connections: ["Okul Ana Binasƒ±", "Yeraltƒ± T√ºnelleri", "√áatƒ± Katƒ±"]
    },
    "Yeraltƒ± T√ºnelleri": {
        description: "Okulun altƒ±ndaki karanlƒ±k ve nemli t√ºneller. Eski sƒ±rlar barƒ±ndƒ±rƒ±yor.",
        events: [
            {name: "Karanlƒ±k D√∂v√º≈ü", weight: 70, handler: "startBattle"},
            // {name: "Antik E≈üya", weight: 30, handler: "findItem"} // KALDIRILDI
        ],
        connections: ["Okul Ana Binasƒ±", "Okul Bah√ßesi"]
    },
    "√áatƒ± Katƒ±": {
        description: "Okulun en y√ºksek noktasƒ±, r√ºzgarlƒ± ve tehlikeli. Nadir e≈üyalar bulunabilir.",
        events: [
            {name: "G√º√ßl√º D√∂v√º≈ü", weight: 90, handler: "startBattle"},
            // {name: "Nadir E≈üya", weight: 10, handler: "findItem"} // KALDIRILDI
        ],
        connections: ["Okul Bah√ßesi"]
    },
    "K√ºt√ºphane": {
        description: "Sessiz ve bilgi dolu bir yer. K√ºt√ºphaneci Zoktay burada bulunur.", // Adƒ± g√ºncellendi
        events: [
            {name: "Kitap Ara", weight: 30, handler: "findItem"}, // Bu olay hala e≈üya bulabilir, ancak artƒ±k bir butonla tetiklenmiyor. Sadece g√∂revler i√ßin kullanƒ±labilir.
            {name: "K√ºt√ºphaneciyle Konu≈ü", weight: 70, handler: "startDialogue", dialogueId: "librarian_intro"}
        ],
        connections: ["Okul Ana Binasƒ±"]
    },
    "Kantin": {
        description: "√ñƒürencilerin toplandƒ±ƒüƒ± g√ºr√ºlt√ºl√º bir yer. Yemek yiyebilir veya dedikodu dinleyebilirsin.",
        events: [
            {name: "Yemek Ye", weight: 50, handler: "rest"},
            {name: "Dedikodu Dinle", weight: 50, handler: "startDialogue", dialogueId: "cantine_gossip"}
        ],
        connections: ["Okul Ana Binasƒ±"]
    },
    "Berat'ƒ±n Ofisi": {
        description: "Berat Hoca'nƒ±n ki≈üisel ofisi. Buradan geri d√∂n√º≈ü yok.",
        events: [
            {name: "Final Boss", weight: 100, handler: "startFinalBoss"}
        ],
        connections: [] // Final konum, baƒülantƒ± yok
    }
};

const quests = [
  {
    id: "quest_001",
    name: "Kayƒ±p Kitap",
    description: "K√ºt√ºphanede kaybolan eski bir kitabƒ± bul.",
    giver: "K√ºt√ºphaneci Zoktay", // Adƒ± g√ºncellendi
    location: "K√ºt√ºphane",
    objective: { type: "findItem", itemId: "ancient_book_001", count: 1 },
    rewards: { exp: 50, item: "kitap_ayraci_001", gold: 20 },
    status: "available", // available, active, completed, failed
    dialogue: {
      start: "Ah, o eski kitap... Onu bulursan sana iyi bir √∂d√ºl veririm.",
      progress: "Kitabƒ± buldun mu?",
      complete: "Harika! ƒ∞≈üte √∂d√ºl√ºn.",
      fail: "Kitap bulunamadƒ±, belki ba≈üka zaman."
    }
  },
  {
    id: "quest_002",
    name: "Berat'ƒ±n Casusu",
    description: "Berat Hoca'nƒ±n casuslarƒ±ndan birini etkisiz hale getir.",
    giver: "Direni≈ü Lideri",
    location: "Okul Bah√ßesi",
    objective: { type: "defeatEnemy", enemyName: "Berat'ƒ±n G√∂zc√ºs√º Yiƒüit Aysu", count: 1 }, // D√º≈üman adƒ± g√ºncellendi
    rewards: { exp: 75, reputation: { resistance: 10 }, gold: 30 },
    status: "available",
    dialogue: {
      start: "Berat'ƒ±n g√∂zc√ºleri her yerde. Birini durdurmalƒ±yƒ±z.",
      progress: "Casusu hallettin mi?",
      complete: "M√ºkemmel! Direni≈ü sana minnettar.",
      fail: "Casus ka√ßtƒ±, dikkatli olmalƒ±yƒ±z."
    }
  }
];

const questTemplates = [
    {
        type: "fetch",
        name: "Kayƒ±p E≈üya Avƒ±",
        description: "B√∂lgedeki kayƒ±p bir e≈üyayƒ± bul.",
        objective: { type: "findItem", itemId: null, count: 1 },
        rewards: { exp: 30, gold: 15 }
    },
    {
        type: "eliminate",
        name: "Tehlikeli D√º≈üman",
        description: "B√∂lgedeki bir d√º≈ümanƒ± etkisiz hale getir.",
        objective: { type: "defeatEnemy", enemyName: null, count: 1 },
        rewards: { exp: 40, gold: 20 }
    }
];

const craftingRecipes = [
  {
    id: "healing_potion_recipe",
    name: "ƒ∞yile≈ütirme ƒ∞ksiri",
    output: { itemId: "protein_bari", count: 1 },
    ingredients: [
      { itemId: "bitki_001", count: 2 },
      { itemId: "su_sisesi_001", count: 1 }
    ]
  }
];

const dialogues = {
    "librarian_intro": [
        { speaker: "K√ºt√ºphaneci Zoktay", text: "Merhaba gen√ß adam/hanƒ±m. Okulun k√ºt√ºphanesine ho≈ü geldin.", options: [{ text: "Merhaba.", next: 1 }, { text: "Ne i≈üin var burada?", next: 2 }] },
        { speaker: "K√ºt√ºphaneci Zoktay", text: (player) => { // Dinamik metin i√ßin fonksiyon
            if (player.k >= 5) {
                return "Ah, ne kadar da ho≈ü bir √∂ƒürenci! Sana nasƒ±l yardƒ±mcƒ± olabilirim?";
            } else {
                return "Sana nasƒ±l yardƒ±mcƒ± olabilirim?";
            }
        }, options: [{ text: "G√∂rev var mƒ±?", action: () => acceptQuest("quest_001") }, { text: "Hi√ßbir ≈üey.", next: "end" }] },
        { speaker: "K√ºt√ºphaneci Zoktay", text: "Burasƒ± benim evim gibi. Sen kimsin?", options: [{ text: "Ben bir √∂ƒürenciyim.", next: 1 }, { text: "Seni ilgilendirmez.", next: "end" }] }
    ],
    "quest_001_start": [
        { speaker: "K√ºt√ºphaneci Zoktay", text: quests.find(q => q.id === "quest_001").dialogue.start, options: [{ text: "Kabul ediyorum.", action: () => acceptQuest("quest_001") }, { text: "≈ûimdi deƒüil.", next: "end" }] }
    ],
    "resistance_intro": [
        { speaker: "Direni≈ü √úyesi", text: "Psikolojik baskƒ±dan bƒ±ktƒ±n mƒ±? Berat Hoca'ya kar≈üƒ± durmak ister misin?", options: [{ text: "Evet!", action: () => startDialogue("quest_002_start") }, { text: "Hayƒ±r, beni ilgilendirmez.", next: "end" }] }
    ],
    "quest_002_start": [
        { speaker: "Direni≈ü √úyesi", text: quests.find(q => q.id === "quest_002").dialogue.start, options: [{ text: "Kabul ediyorum.", action: () => acceptQuest("quest_002") }, { text: "≈ûimdi deƒüil.", next: "end" }] }
    ],
    "cantine_gossip": [
        { speaker: "Kantin G√∂revlisi", text: "Bug√ºn ne alƒ±rsƒ±n? Yoksa sadece dedikodu mu dinleyeceksin?", options: [{ text: "Dedikodu.", next: 1 }, { text: "Yemek.", action: () => restEvent(), next: "end" }] },
        { speaker: "Kantin G√∂revlisi", text: "Duydun mu? Berat Hoca'nƒ±n yeni bir g√∂zc√ºs√º varmƒ±≈ü, yeraltƒ± t√ºnellerinde takƒ±lƒ±yormu≈ü. Adƒ± da Yiƒüit Aysu'ymu≈ü.", options: [{ text: "ƒ∞lgin√ß.", next: "end" }] } // Diyalog g√ºncellendi
    ]
};

// NPC'ler ve rutinleri
const npcs = [
    {
        id: "librarian_zoktay", // ID g√ºncellendi
        name: "K√ºt√ºphaneci Zoktay", // Adƒ± g√ºncellendi
        currentLocation: "K√ºt√ºphane",
        routine: [
            { time: "day", location: "K√ºt√ºphane", action: "work" },
            { time: "night", location: "Okul Ana Binasƒ±", action: "rest" }
        ]
    },
    {
        id: "berat_guard_01",
        name: "Berat'ƒ±n G√∂zc√ºs√º",
        currentLocation: "Okul Ana Binasƒ±",
        routine: [
            { time: "day", location: "Okul Ana Binasƒ±", action: "patrol" },
            { time: "night", location: "Yeraltƒ± T√ºnelleri", action: "patrol" }
        ]
    }
];


/* ========== UI REFS ========== */
const characterCreationPanel = document.getElementById("characterCreationPanel");
const selectBtn = document.getElementById("selectBtn");
const resetBtn = document.getElementById("resetBtn");
const stepLabel = document.getElementById("stepLabel");
const stepResult = document.getElementById("stepResult");
const optionsList = document.getElementById("optionsList");

const statClanEl = document.getElementById("statClan");
const statGucEl = document.getElementById("statGuc");
const statHizEl = document.getElementById("statHiz");
const statKarizmaEl = document.getElementById("statKarizma");
const statStyleEl = document.getElementById("statStyle");
const statHPEl = document.getElementById("statHP");
const statLevel = document.getElementById("statLevel");
const statExp = document.getElementById("statExp");
const inventoryEl = document.getElementById("inventory");
const equipmentDisplayEl = document.getElementById("equipmentDisplay");
const goldDisplayEl = document.getElementById("goldDisplay");

const gameContainer = document.getElementById("gameContainer");
const gameStatsDisplay = document.getElementById("gameStatsDisplay");
const gameStatClanEl = document.getElementById("gameStatClan");
const gameStatStyleEl = document.getElementById("gameStatStyle");
const gameStatGucEl = document.getElementById("gameStatGuc");
const gameStatHizEl = document.getElementById("gameStatHiz");
const gameStatKarizmaEl = document.getElementById("gameStatKarizma");
const gameStatHPEl = document.getElementById("gameStatHPEl"); // D√ºzeltildi
const gameStatLevel = document.getElementById("gameStatLevel");
const gameStatExp = document.getElementById("statExp");
const gameInventoryEl = document.getElementById("gameInventory");
const gameEquipmentDisplayEl = document.getElementById("gameEquipmentDisplay");
const gameGoldDisplayEl = document.getElementById("gameGoldDisplay");
const fightsWonDisplay = document.getElementById("fightsWonDisplay");
const gameLocationDisplayEl = document.getElementById("gameLocationDisplay");
const gameTimeDisplayEl = document.getElementById("gameTimeDisplay");
const gameWeatherDisplayEl = document.getElementById("gameWeatherDisplay");


const startGameBtn = document.getElementById("startGameBtn");
const adventureArea = document.getElementById("adventureArea");
const eventDescriptionDiv = document.getElementById("eventDescription");
const eventActionsDiv = document.getElementById("eventActions");
const gameLog = document.getElementById("gameLog");

const finalPanel = document.getElementById("finalPanel");
const finalLog = document.getElementById("finalLog");
const restartAllBtn = document.getElementById("restartAllBtn");

/* ========== GAME STATE ========== */
const steps = ["klan","guc","hiz","karizma","hp","dovusStili"];
let currentStepIndex = 0;
let currentOptions = [];
let selecting = false;
let selectedClan=null, selectedGuc=null, selectedHiz=null, selectedKarizma=null, selectedHP=null, selectedStyle=null;

let player = {
  g:0,h:0,k:0, style:null,
  level:1, exp:0,
  HP:0, maxHP:0,
  inventory:[],
  equipment: {
    mainHand: null,
    offHand: null,
    head: null,
    body: null,
    legs: null,
    feet: null,
    accessory1: null,
    accessory2: null
  },
  specialAbilities: [
    { id: "guclu_vurus", name: "G√º√ßl√º Vuru≈ü", cooldown: 3, currentCooldown: 0, effect: { damageMultiplier: 1.5, cost: 5 } },
    { id: "hizli_kacis", name: "Hƒ±zlƒ± Ka√ßƒ±≈ü", cooldown: 5, currentCooldown: 0, effect: { escapeChanceBonus: 0.2, cost: 3 } }
  ],
  activeQuests: [],
  completedQuests: [],
  reputation: {
    resistance: 0,
    berat_faction: 0
  },
  gold: 0,
  currentLocation: "Okul Ana Binasƒ±",
  timeOfDay: "day", // day, night
  weather: "clear", // clear, rain, snow
  timeCounter: 0, // Zaman d√∂ng√ºs√º i√ßin saya√ß
  actionsTaken: 0 // Oyuncunun yaptƒ±ƒüƒ± hareket sayƒ±sƒ±
};

let currentEnemy = null;
let consecutiveEscapes = 0;
let fightsWon = 0;
let currentZone = 1; // Zone can be tied to player level or progress

let originalSelectBtnOnClick = null;
let currentDialogueState = {
    dialogueId: null,
    currentLineIndex: 0,
    currentDialogueData: null
};

let lastGameLoopTime = 0; // Ana oyun d√∂ng√ºs√º i√ßin zaman damgasƒ±
let currentView = "characterCreation"; // 'characterCreation', 'location', 'inventory', 'quests', 'crafting', 'battle', 'dialogue'
let isPlayerTurn = true; // Oyuncu sƒ±rasƒ± mƒ±?


/* ========== YENƒ∞ AI VE Dƒ∞NAMƒ∞K Sƒ∞STEMLER ========== */

// D√º≈üman AI Sƒ±nƒ±fƒ±
class EnemyAI {
    constructor(enemyInstance, playerInstance) {
        this.enemy = enemyInstance;
        this.player = playerInstance;
        this.currentState = "IDLE"; // IDLE, ATTACKING, FLEEING, PURSUING
        this.target = playerInstance;
        this.actionCooldown = 1000; // AI'ƒ±n karar verme sƒ±klƒ±ƒüƒ± (ms)
        this.lastActionTime = 0;
    }

    update(deltaTime) {
        this.lastActionTime += deltaTime;
        if (this.lastActionTime < this.actionCooldown) {
            return; // Hen√ºz aksiyon zamanƒ± deƒüil
        }
        this.lastActionTime = 0;

        // Durum ge√ßi≈ü mantƒ±ƒüƒ±
        if (this.enemy.HP / this.enemy.maxHP < 0.3 && this.currentState !== "FLEEING") {
            this.currentState = "FLEEING";
            gameLogInsert(`üëπ ${this.enemy.name} canƒ± azaldƒ±, ka√ßmaya √ßalƒ±≈üƒ±yor!`);
        } else if (this.currentState === "FLEEING" && this.enemy.HP / this.enemy.maxHP >= 0.7) {
            this.currentState = "IDLE"; // Canƒ± iyile≈üirse geri d√∂nebilir
            gameLogInsert(`üëπ ${this.enemy.name} toparlandƒ±.`);
        } else if (this.currentState === "IDLE" && this.isPlayerNearby()) {
            this.currentState = "ATTACKING";
            gameLogInsert(`üëπ ${this.enemy.name} seni fark etti!`);
        } else if (this.currentState === "ATTACKING" && !this.isPlayerNearby()) {
            this.currentState = "IDLE"; // Oyuncu uzakla≈üƒ±rsa
            gameLogInsert(`üëπ ${this.enemy.name} seni kaybetti.`);
        }

        // Mevcut duruma g√∂re aksiyon al
        switch (this.currentState) {
            case "IDLE":
                // D√º≈üman bo≈üta, bir ≈üey yapmƒ±yor
                break;
            case "ATTACKING":
                // D√º≈üman saldƒ±rƒ±yor (sava≈ü modunda bu zaten y√∂netiliyor)
                // Burada sadece sava≈ü dƒ±≈üƒ± bir durumda oyuncuya yakla≈üma mantƒ±ƒüƒ± olabilir
                break;
            case "FLEEING":
                // D√º≈üman ka√ßƒ±yor (sava≈ü modunda bu zaten y√∂netiliyor)
                break;
            case "PURSUING":
                // D√º≈üman oyuncuyu takip ediyor
                break;
        }
    }

    isPlayerNearby() {
        // Basit bir kontrol: Eƒüer sava≈ü aktifse, oyuncu yakƒ±ndadƒ±r.
        // Daha karma≈üƒ±k bir sistemde, d√º≈ümanƒ±n konumu ve oyuncunun konumu kar≈üƒ±la≈ütƒ±rƒ±lƒ±r.
        return currentEnemy === this.enemy; // Sadece aktif d√º≈üman i√ßin ge√ßerli
    }
}

// NPC Rutinlerini G√ºncelleme
function updateNPCs() {
    const currentTime = player.timeOfDay;
    npcs.forEach(npc => {
        const currentRoutine = npc.routine.find(r => r.time === currentTime);
        if (currentRoutine && npc.currentLocation !== currentRoutine.location) {
            const oldLocation = npc.currentLocation;
            npc.currentLocation = currentRoutine.location;
            gameLogInsert(`üö∂ ${npc.name} ${oldLocation} konumundan ${currentRoutine.location} konumuna gitti.`);
        }
    });
}

// Dinamik G√∂rev Olu≈üturma
function generateDynamicQuest() {
    const template = questTemplates[Math.floor(Math.random() * questTemplates.length)];
    const newQuest = JSON.parse(JSON.stringify(template)); // ≈ûablonu kopyala

    newQuest.id = `dynamic_quest_${Date.now()}`; // Benzersiz ID
    newQuest.status = "available";
    newQuest.giver = "Gizemli Yabancƒ±"; // Veya dinamik olarak bir NPC ata

    // Rastgele bir konum se√ß
    const locations = Object.keys(worldLocations).filter(loc => worldLocations[loc].connections.length > 0);
    newQuest.location = locations[Math.floor(Math.random() * locations.length)];

    if (newQuest.type === "fetch") {
        const randomItem = items[Math.floor(Math.random() * items.length)];
        newQuest.objective.itemId = randomItem.id;
        newQuest.name = `Kayƒ±p ${randomItem.name} Avƒ±`;
        newQuest.description = `${newQuest.location} b√∂lgesinde kayƒ±p ${randomItem.name}'i bul.`;
    } else if (newQuest.type === "eliminate") {
        const randomEnemyName = enemyNames[Math.floor(Math.random() * enemyNames.length)].name;
        newQuest.objective.enemyName = randomEnemyName;
        newQuest.name = `${randomEnemyName} Avƒ±`;
        newQuest.description = `${newQuest.location} b√∂lgesindeki ${randomEnemyName}'i yen.`;
    }

    // Olu≈üturulan g√∂revi global g√∂rev listesine ekle
    quests.push(newQuest);
    gameLogInsert(`üìú Yeni bir dinamik g√∂rev ortaya √ßƒ±ktƒ±: "${newQuest.name}" (${newQuest.location})`);
    return newQuest;
}

// Yetenek Cooldown'larƒ±nƒ± Azaltma
function decreaseAbilityCooldowns(deltaTime) {
    player.specialAbilities.forEach(ability => {
        if (ability.currentCooldown > 0) {
            ability.currentCooldown -= deltaTime / 1000; // Saniyeye √ßevir
            if (ability.currentCooldown < 0) ability.currentCooldown = 0;
        }
    });
}

/* ========== TEMEL FONKSƒ∞YONLAR ========== */
function pickWeightedIndex(arr){
  const total = arr.reduce((s,x)=>s+(x.weight||0),0);
  if (total === 0) return -1;
  let r = Math.random()*total;
  for(let i=0;i<arr.length;i++){
    if(r < (arr[i].weight||0)) return i;
    r -= (arr[i].weight||0);
  }
  return arr.length-1;
}

function getOptionsForStep(step){
  if(step === "klan"){
    return clans.map(c=>({label:c.name, value:c, weight:c.weight}));
  } else if(step === "dovusStili"){
    return fightingStyles.map(s=>({label:s.name, value:s, weight:s.weight}));
  } else if(step === "hp" || step === "guc" || step === "hiz" || step === "karizma"){
    return statSegments();
  } else {
    return [];
  }
}

function statSegments(){
  return [
    {label:"1", value:1, weight:20}, {label:"2", value:2, weight:18},
    {label:"3", value:3, weight:15}, {label:"4", value:4, weight:12},
    {label:"5", value:5, weight:10}, {label:"6", value:6, weight:8},
    {label:"7", value:7, weight:6},  {label:"8", value:8, weight:5},
    {label:"9", value:9, weight:4},  {label:"10",value:10,weight:2}
  ];
}

function renderOptions(options){
  optionsList.innerHTML = "";
  const totalWeight = options.reduce((sum, opt) => sum + (opt.weight || 0), 0);

  if (options.length === 0) {
      optionsList.innerHTML = "<li>Se√ßenek bulunamadƒ±.</li>";
      return;
  }

  options.forEach(opt => {
    const li = document.createElement("li");
    const probability = totalWeight > 0 ? ((opt.weight / totalWeight) * 100).toFixed(1) : 0;
    li.innerHTML = `<span>${opt.label}</span> <span class="probability">${probability}%</span>`;
    li.dataset.value = JSON.stringify(opt.value);
    optionsList.appendChild(li);
  });
}

function animateSelection(selectedIndex, callback){
  const items = Array.from(optionsList.children);
  if (items.length === 0 || selectedIndex === -1) {
      callback();
      return;
  }

  let currentIndex = 0;
  let animationCount = 0;
  const maxAnimations = items.length * 3;

  const interval = setInterval(() => {
    if (animationCount >= maxAnimations + selectedIndex) {
      clearInterval(interval);
      items.forEach(item => item.classList.remove("highlight"));
      if (selectedIndex !== -1) {
        items[selectedIndex].classList.add("highlight");
      }
      setTimeout(callback, 500);
      return;
    }

    items.forEach(item => item.classList.remove("highlight"));
    items[currentIndex].classList.add("highlight");

    currentIndex = (currentIndex + 1) % items.length;
    animationCount++;
  }, 80);
}

function handleSelection(seg, isGuaranteed = false){
  const step = steps[currentStepIndex];
  let resultText = "";

  if(step === "klan"){
    selectedClan = seg.value;
    statClanEl.textContent = selectedClan.name;
    resultText = `Klan: ${selectedClan.name}`;
  } else if(step === "guc"){
    selectedGuc = seg.value;
    statGucEl.textContent = selectedGuc;
    resultText = `G√º√ß: ${selectedGuc}`;
  } else if(step === "hiz"){
    selectedHiz = seg.value;
    statHizEl.textContent = selectedHiz;
    resultText = `Hƒ±z: ${selectedHiz}`;
  } else if(step === "karizma"){
    selectedKarizma = seg.value;
    statKarizmaEl.textContent = selectedKarizma;
    resultText = `Karizma: ${selectedKarizma}`;
  } else if(step === "hp"){
    selectedHP = seg.value;
    statHPEl.textContent = selectedHP;
    resultText = `Ba≈ülangƒ±√ß Can: ${selectedHP}`;
  }
  else if(step === "dovusStili"){
    selectedStyle = seg.value;
    statStyleEl.textContent = selectedStyle.name;
    resultText = `D√∂v√º≈ü Stili: ${selectedStyle.name}`;
  }
  
  stepResult.textContent = isGuaranteed ? `Garanti: ${resultText}` : resultText;

  currentStepIndex++;
  if(currentStepIndex < steps.length){
    setTimeout(updateStep, 1000);
  } else {
    setTimeout(finalizeCreation, 1000);
  }
}

function updateStep(){
  const step = steps[currentStepIndex];
  const labels = {
    klan:"Adƒ±m 1/6: Klan",
    guc:"Adƒ±m 2/6: G√º√ß",
    hiz:"Adƒ±m 3/6: Hƒ±z",
    karizma:"Adƒ±m 4/6: Karizma",
    hp:"Adƒ±m 5/6: Ba≈ülangƒ±√ß Can",
    dovusStili:"Adƒ±m 6/6: D√∂v√º≈ü Stili"
  };
  stepLabel.textContent = labels[step] || "‚Äî";
  stepResult.textContent = "";
  selectBtn.disabled = false;
  selecting = false;

  if(step === "dovusStili" && selectedClan && selectedClan.guaranteedStyle){
    const gs = fightingStyles.find(s=> s.name === selectedClan.guaranteedStyle);
    if(gs){
      selectBtn.disabled = true;
      selecting = true;
      const options = getOptionsForStep(step);
      const guaranteedIndex = options.findIndex(opt => opt.value.name === gs.name);
      if (guaranteedIndex !== -1) {
        renderOptions(options);
        animateSelection(guaranteedIndex, () => handleSelection({value: gs}, true));
      } else {
        currentOptions = getOptionsForStep(step);
        renderOptions(currentOptions);
        selectBtn.disabled = false;
        selecting = false;
      }
      return;
    }
  }

  currentOptions = getOptionsForStep(step);
  renderOptions(currentOptions);
}

function finalizeCreation(){
  if(!selectedStyle) {
    const defaultStyleIndex = pickWeightedIndex(fightingStyles);
    selectedStyle = fightingStyles[defaultStyleIndex !== -1 ? defaultStyleIndex : 0];
  }
  
  player.g = (selectedGuc || 1) + (selectedClan?.bonus?.g || 0) + (selectedStyle?.bonus || 0);
  player.h = (selectedHiz || 1) + (selectedClan?.bonus?.h || 0);
  player.k = (selectedKarizma || 1) + (selectedClan?.bonus?.k || 0);
  player.style = selectedStyle?.name || "Yok";
  player.level = 1; player.exp = 0;
  player.maxHP = 10 + (selectedHP || 0) + Math.floor((player.g + player.h + player.k)/3);
  player.HP = player.maxHP;

  updatePlayerStatsUI();

  stepLabel.textContent = "Olu≈üturma Tamamlandƒ±";
  stepResult.textContent = "Karakter hazƒ±r ‚Äî B√ñRSGAME'e ba≈üla!";
  selectBtn.disabled = true;
  startGameBtn.classList.remove("hidden");
  startGameBtn.addEventListener("click", startGame, {once:true});
}

function calculatePlayerStats() {
  let totalG = (selectedGuc || 1) + (selectedClan?.bonus?.g || 0) + (selectedStyle?.bonus || 0);
  let totalH = (selectedHiz || 1) + (selectedClan?.bonus?.h || 0);
  let totalK = (selectedKarizma || 1) + (selectedClan?.bonus?.k || 0);
  let totalHPBonus = 0;

  // Ekipman bonuslarƒ±nƒ± ekle
  for (const slot in player.equipment) {
    const item = player.equipment[slot];
    if (item) {
      if (item.effect.g) totalG += item.effect.g;
      if (item.effect.h) totalH += item.effect.h;
      if (item.effect.k) totalK += item.effect.k;
      if (item.effect.hp) totalHPBonus += item.effect.hp;
    }
  }
  
  // Envanterdeki kalƒ±cƒ± e≈üya bonuslarƒ±nƒ± ekle (Sikit'in ≈ûanslƒ± √áorabƒ± gibi)
  player.inventory.forEach(item => {
      if (item.type === "permanent") { // "permanent" type for items like "Sikit'in ≈ûanslƒ± √áorabƒ±"
          if (item.effect.g) totalG += item.effect.g;
          if (item.effect.h) totalH += item.effect.h;
          if (item.effect.k) totalK += item.effect.k;
      }
  });

  player.g = totalG;
  player.h = totalH;
  player.k = totalK;
  player.maxHP = 10 + (selectedHP || 0) + Math.floor((player.g + player.h + player.k)/3) + totalHPBonus;
  // HP'nin maxHP'yi ge√ßmemesini saƒüla
  player.HP = Math.min(player.HP, player.maxHP);
}


function updatePlayerStatsUI(){
    calculatePlayerStats(); // Her UI g√ºncellemesinde statlarƒ± yeniden hesapla

    statGucEl.textContent = player.g;
    statHizEl.textContent = player.h;
    statKarizmaEl.textContent = player.k;
    statClanEl.textContent = selectedClan ? selectedClan.name : "Bilinmiyor";
    statStyleEl.textContent = player.style;
    statHPEl.textContent = `${player.HP}/${player.maxHP}`;
    statLevel.textContent = player.level;
    statExp.textContent = player.exp;
    goldDisplayEl.textContent = player.gold;

    gameStatClanEl.textContent = selectedClan ? selectedClan.name : "Bilinmiyor";
    gameStatStyleEl.textContent = player.style;
    gameStatGucEl.textContent = player.g;
    gameStatHizEl.textContent = player.h;
    gameStatKarizmaEl.textContent = player.k;
    gameStatHPEl.textContent = `${player.HP}/${player.maxHP}`;
    gameStatLevel.textContent = player.level;
    gameStatExp.textContent = player.exp;
    gameGoldDisplayEl.textContent = player.gold;
    gameLocationDisplayEl.textContent = player.currentLocation;
    gameTimeDisplayEl.textContent = player.timeOfDay === "day" ? "G√ºnd√ºz" : "Gece";
    gameWeatherDisplayEl.textContent = player.weather === "clear" ? "A√ßƒ±k" : player.weather === "rain" ? "Yaƒümurlu" : "Karlƒ±";
    
    updateInventoryUI();
    updateEquipmentUI();
    updateFightsWonDisplay();
}

function updateInventoryUI(){
    if (player.inventory.length === 0) {
        inventoryEl.textContent = "Bo≈ü";
        gameInventoryEl.textContent = "Bo≈ü";
    } else {
        const inventoryNames = player.inventory.map(item => item.name).join(", ");
        inventoryEl.textContent = inventoryNames;
        gameInventoryEl.textContent = inventoryNames;
    }
}

function updateEquipmentUI(){
    let equippedItems = [];
    for (const slot in player.equipment) {
        if (player.equipment[slot]) {
            equippedItems.push(`${player.equipment[slot].name} (${slot})`);
        }
    }
    if (equippedItems.length === 0) {
        equipmentDisplayEl.textContent = "Bo≈ü";
        gameEquipmentDisplayEl.textContent = "Bo≈ü";
    } else {
        equipmentDisplayEl.textContent = equippedItems.join(", ");
        gameEquipmentDisplayEl.textContent = equippedItems.join(", ");
    }
}

function updateFightsWonDisplay(){
    fightsWonDisplay.textContent = `${fightsWon}/15`;
}

function gameLogInsert(txt){
    const d=document.createElement("div");
    d.innerHTML = txt;
    gameLog.appendChild(d);
    gameLog.scrollTop = gameLog.scrollHeight;
}

/* ========== OYUN D√ñNG√úS√ú VE MEKANƒ∞KLER ========== */

// Ana Oyun D√∂ng√ºs√º (Artƒ±k zamanƒ± otomatik ilerletmiyor)
function gameLoop(currentTime) {
    // Bu fonksiyon artƒ±k zamanƒ± otomatik ilerletmiyor.
    // Sadece yetenek cooldown'larƒ±nƒ± ve d√º≈üman AI'ƒ±nƒ± g√ºncelliyor.
    // Zaman ilerlemesi handlePlayerAction() i√ßinde y√∂netiliyor.

    if (gameContainer.classList.contains("hidden") || finalPanel.classList.contains("hidden") === false) {
        requestAnimationFrame(gameLoop);
        return;
    }

    // D√º≈üman AI'ƒ±nƒ± g√ºncelle (sadece sava≈ü aktifse)
    if (currentEnemy && currentEnemy.ai) {
        currentEnemy.ai.update(0); // DeltaTime'ƒ± burada kullanmƒ±yoruz, AI kendi i√ß zamanlamasƒ±nƒ± y√∂netebilir
    }

    // Yetenek cooldown'larƒ±nƒ± azalt (her frame'de)
    const deltaTime = currentTime - lastGameLoopTime;
    if (lastGameLoopTime !== 0) { // ƒ∞lk √ßaƒürƒ±da deltaTime 0 olmasƒ±n
        decreaseAbilityCooldowns(deltaTime);
    }
    lastGameLoopTime = currentTime;

    // UI g√ºncellemeleri (sadece sava≈ü sƒ±rasƒ±nda veya statlar deƒüi≈ütiƒüinde)
    // updatePlayerStatsUI(); // Bu artƒ±k her hareket sonrasƒ± √ßaƒürƒ±lƒ±yor

    requestAnimationFrame(gameLoop);
}


function startGame(){
  characterCreationPanel.classList.add("hidden");
  gameContainer.classList.remove("hidden");

  document.getElementById("gameIntro").classList.add("hidden");
  gameLog.innerHTML = "";
  fightsWon = 0;
  currentZone = 1;
  player.currentLocation = "Okul Ana Binasƒ±"; // Ba≈ülangƒ±√ß konumu
  player.timeOfDay = "day";
  player.weather = "clear";
  player.timeCounter = 0; // Zaman sayacƒ±nƒ± sƒ±fƒ±rla
  player.actionsTaken = 0; // Aksiyon sayacƒ±nƒ± sƒ±fƒ±rla
  
  gameLogInsert("üìñ B√ñRSGAME: A√ßƒ±k D√ºnya Hikayesi");
  gameLogInsert("Okulun kapƒ±sƒ±ndan her g√ºn aynƒ± ≈üekilde giriyorsun ama bu sefer farklƒ±. Koridorlarƒ±n, bah√ßenin, t√ºnellerin hepsinin ardƒ±nda g√∂r√ºnmeyen bir d√ºzen var. Herkes aynƒ± ≈üeye fƒ±sƒ±ldƒ±yor: ‚ÄúBu okulun ger√ßek sahibi ders anlatan hocalar deƒüil‚Ä¶ Berat Hoca.‚Äù");
  gameLogInsert("Berat Hoca sƒ±radan bir √∂ƒüretmen gibi g√∂r√ºnse de aslƒ±nda okulun g√∂lgesinde b√ºy√ºyen bir √∂rg√ºt√ºn lideri. Dersler, sƒ±navlar, teneff√ºsler‚Ä¶ bunlarƒ±n hepsi sadece bir maske. Perde arkasƒ±nda o, √∂ƒürenciler √ºzerinde psikolojik bir aƒü √∂r√ºyor. Sadƒ±k korumalarƒ±, gizli tuzaklarƒ±, kendi d√ºzeni var. Amacƒ± basit: okuldaki herkesi kontrol altƒ±na almak.");
  gameLogInsert("Sen ise sƒ±radan bir √∂ƒürencisin. Hi√ßbir ayrƒ±calƒ±ƒüƒ±n yok, kimse seni kurtarmayacak. Ama i√ßinde susmayan bir d√ºrt√º var: √∂zg√ºrl√ºk.");
  gameLogInsert("Arkada≈ülarƒ±n korkudan sessiz kalƒ±yor, bazƒ±larƒ± ise Berat Hoca‚Äônƒ±n d√ºzenine katƒ±lƒ±p g√º√ß uƒüruna ona hizmet ediyor. Sen ise bu oyunda tarafsƒ±z kalamazsƒ±n.");
  gameLogInsert("Okulda gideceƒüin her yol seni farklƒ± bir yola s√ºr√ºkleyecek...");
  
  updatePlayerStatsUI();
  
  renderLocationActions();

  // Ana oyun d√∂ng√ºs√ºn√º ba≈ülat
  lastGameLoopTime = 0;
  requestAnimationFrame(gameLoop);
}

function handlePlayerAction() {
    player.actionsTaken++;
    if (player.actionsTaken >= 5) { // Her 5 harekette bir zaman ge√ßsin
        updateTimeAndWeather();
        player.actionsTaken = 0;
    }
    updatePlayerStatsUI(); // UI'ƒ± her hareket sonrasƒ± g√ºncelle
}

function renderLocationActions(){
  currentView = "location"; // G√∂r√ºn√ºm√º ana konum olarak ayarla
  eventActionsDiv.innerHTML = "";
  eventDescriptionDiv.innerHTML = `<h3>üåç Ke≈üif Modu - ${player.currentLocation}</h3><p>Nereye gitmek istersin?</p>`;
  
  const currentLocationData = worldLocations[player.currentLocation];
  
  // Konum baƒülantƒ±larƒ±nƒ± g√∂ster
  currentLocationData.connections.forEach(connectedLoc => {
    const btn = document.createElement("button");
    btn.textContent = `Git: ${connectedLoc}`;
    btn.onclick = () => {
        changeLocation(connectedLoc);
        handlePlayerAction(); // Her hareket sonrasƒ± zamanƒ± kontrol et
    };
    eventActionsDiv.appendChild(btn);
  });

  // Konuma √∂zel olaylarƒ± g√∂ster
  currentLocationData.events.forEach(event => {
      const btn = document.createElement("button");
      btn.textContent = event.name;
      btn.onclick = () => {
          handleLocationEvent(event);
          handlePlayerAction(); // Her hareket sonrasƒ± zamanƒ± kontrol et
      };
      eventActionsDiv.appendChild(btn);
  });

  // Rastgele ke≈üfet butonu
  const exploreBtn = document.createElement("button");
  exploreBtn.textContent = "Rastgele Ke≈üfet";
  exploreBtn.onclick = () => {
      exploreRandomEvent();
      handlePlayerAction(); // Her hareket sonrasƒ± zamanƒ± kontrol et
  };
  eventActionsDiv.appendChild(exploreBtn);

  // Men√º butonlarƒ±nƒ± ayrƒ± bir satƒ±rda veya gruplandƒ±rƒ±lmƒ±≈ü olarak g√∂ster
  const menuButtonsContainer = document.createElement("div");
  menuButtonsContainer.style.display = "flex";
  menuButtonsContainer.style.gap = "8px";
  menuButtonsContainer.style.marginTop = "10px";
  menuButtonsContainer.style.justifyContent = "center"; // Men√º butonlarƒ±nƒ± ortala

  const inventoryBtn = document.createElement("button");
  inventoryBtn.textContent = "Envanter";
  inventoryBtn.onclick = () => openInventory();
  menuButtonsContainer.appendChild(inventoryBtn);

  const questLogBtn = document.createElement("button");
  questLogBtn.textContent = "G√∂revler";
  questLogBtn.onclick = () => openQuestLog();
  menuButtonsContainer.appendChild(questLogBtn);

  const craftingBtn = document.createElement("button");
  craftingBtn.textContent = "Zanaat";
  craftingBtn.onclick = () => openCraftingMenu();
  menuButtonsContainer.appendChild(craftingBtn);

  eventActionsDiv.appendChild(menuButtonsContainer);
}

function changeLocation(newLocation) {
    gameLogInsert(`üö∂ ${newLocation} konumuna ge√ßtin...`);
    player.currentLocation = newLocation;
    // updateTimeAndWeather(); // Zaman ve hava durumu artƒ±k ana d√∂ng√ºde g√ºncelleniyor
    updatePlayerStatsUI(); // Konum deƒüi≈ütiƒüinde UI'ƒ± g√ºncelle
    renderLocationActions();
}

function handleLocationEvent(event) {
    gameLogInsert(`‚ö° ${event.name} olayƒ± ger√ßekle≈üti!`);
    setTimeout(() => {
        if (event.handler === "startBattle") {
            encounterEnemy();
        } else if (event.handler === "startFinalBoss") {
            startFinalBoss();
        } else if (event.handler === "findItem") {
            findItem();
        } else if (event.handler === "rest") {
            restEvent();
        } else if (event.handler === "startDialogue") {
            startDialogue(event.dialogueId);
        } else {
            gameLogInsert("Bilinmeyen olay t√ºr√º. Ke≈üif devam ediyor...");
            renderLocationActions();
        }
    }, 800);
}

function exploreRandomEvent() {
    const currentLocationData = worldLocations[player.currentLocation];
    const events = currentLocationData.events;
    if (events && events.length > 0) {
        const eventIndex = pickWeightedIndex(events);
        if (eventIndex !== -1) {
            handleLocationEvent(events[eventIndex]);
            return;
        }
    }
    gameLogInsert("Bu konumda rastgele ke≈üfedilecek bir ≈üey bulunamadƒ±.");
    renderLocationActions();
}

function updateTimeAndWeather() {
    // Basit bir g√ºnd√ºz/gece d√∂ng√ºs√º
    player.timeOfDay = (player.timeOfDay === "day") ? "night" : "day";
    gameLogInsert(`‚è∞ Zaman: ${player.timeOfDay === "day" ? "G√ºnd√ºz" : "Gece"}`);

    // Hava durumu rastgele deƒüi≈üebilir
    const weatherOptions = ["clear", "rain", "snow"];
    player.weather = weatherOptions[Math.floor(Math.random() * weatherOptions.length)];
    gameLogInsert(`‚òÅÔ∏è Hava Durumu: ${player.weather === "clear" ? "A√ßƒ±k" : player.weather === "rain" ? "Yaƒümurlu" : "Karlƒ±"}`);

    // Hava durumuna g√∂re ek olaylar
    if (player.weather === "rain") {
        gameLogInsert("üåßÔ∏è Yaƒümur g√∂r√º≈ü√º kƒ±sƒ±tlƒ±yor, d√º≈ümanlar seni daha zor fark edebilir.");
        // D√º≈ümanlarƒ±n algƒ± menzilini ge√ßici olarak azaltma gibi bir mekanik eklenebilir
    } else if (player.weather === "snow") {
        gameLogInsert("‚ùÑÔ∏è Kar fƒ±rtƒ±nasƒ± ba≈üladƒ±, hareket etmek zorla≈üƒ±yor.");
        // Oyuncunun hƒ±zƒ±nƒ± ge√ßici olarak azaltma gibi bir mekanik eklenebilir
    }
    updateNPCs(); // NPC'leri de zamanla g√ºncelle
    if (Math.random() < 0.3) { // %30 ≈üansla yeni dinamik g√∂rev
        generateDynamicQuest();
    }
}

function generateEnemy(zone, isBoss = false) {
  const zoneScale = [0, 0.6, 1.0, 1.6, 2.3, 3.0];
  const scale = zoneScale[Math.min(zone, zoneScale.length - 1)];
  
  let atk, def, hp, name;

  if (isBoss) {
    name = "Berat Hoca (Final Boss)";
    atk = Math.max(12, Math.floor(18 + scale * 6));
    def = Math.max(6, Math.floor(12 + scale * 4));
    hp = Math.max(60, Math.floor(80 + scale * 25));
  } else {
    let enemyPool = enemyNames.filter(e => zone >= e.minZone && zone <= e.maxZone);
    if (enemyPool.length === 0) enemyPool = enemyNames;
    
    const selectedEnemy = enemyPool[Math.floor(Math.random() * enemyPool.length)];
    name = selectedEnemy.name; // Burasƒ± zaten g√ºncel enemyNames'i kullanacak
    
    atk = Math.max(2, Math.floor(3 + scale * 2.5));
    def = Math.max(1, Math.floor(2 + scale * 1.5));
    hp = Math.max(8, Math.floor(12 + scale * 6));

    const randomStyle = enemyFightingStyles[Math.floor(Math.random() * enemyFightingStyles.length)];
    // name = `${randomStyle.name} ${name}`; // Bu satƒ±rƒ± kaldƒ±rƒ±n veya yorum satƒ±rƒ± yapƒ±n
    // Artƒ±k enemyNames i√ßinde zaten "Hƒ±zlƒ± Tekme Yiƒüit Aysu" gibi isimler var.
    // Eƒüer "Hƒ±zlƒ± Tekme" gibi √∂n ekleri stil olarak eklemek isterseniz, bu satƒ±rƒ± bƒ±rakabilirsiniz.
    atk += (randomStyle.bonus.atk || 0);
    def += (randomStyle.bonus.def || 0);
    hp += (randomStyle.bonus.speed || 0);
  }

  const behavior = enemyBehaviors[Math.floor(Math.random() * enemyBehaviors.length)];
  
  const enemy = {name, atk, def, HP: hp, maxHP: hp, zone, behavior, isBoss};
  enemy.ai = new EnemyAI(enemy, player); // D√º≈ümana AI objesi ata
  return enemy;
}

function encounterEnemy() {
  currentEnemy = generateEnemy(currentZone);
  currentView = "battle";
  
  eventDescriptionDiv.innerHTML = `
    <strong>‚öîÔ∏è B√∂lge ${currentZone} - Kar≈üƒ±nda: ${currentEnemy.name}</strong>
    <p>Can: <span class="enemy-hp">${currentEnemy.HP}/${currentEnemy.maxHP}</span></p>
    <p>Saldƒ±rƒ±: ${currentEnemy.atk} ‚Ä¢ Savunma: ${currentEnemy.def}</p>
  `;

  gameLogInsert(`‚ö° ${currentEnemy.name} ile kar≈üƒ±la≈ütƒ±n!`);

  if (Math.random() < currentEnemy.behavior.attackFirstChance) {
    gameLogInsert(`${currentEnemy.name} seni hemen saldƒ±rdƒ±!`);
    setTimeout(() => {
      const enemyDamage = calculateDamage(currentEnemy.atk, player.g);
      player.HP -= enemyDamage;
      gameLogInsert(`${currentEnemy.name} seni vurdu! ${enemyDamage} hasar aldƒ±n. (Can: ${player.HP}/${player.maxHP})`);
      updatePlayerStatsUI();
      
      if (player.HP <= 0) {
        onPlayerDefeated();
      } else {
        isPlayerTurn = true; // D√º≈üman ilk saldƒ±rdƒ±ysa sƒ±ra oyuncuya ge√ßer
        renderBattleActions();
      }
    }, 1200);
  } else {
    isPlayerTurn = true; // Oyuncu ilk ba≈ülar
    showEnemyEncounterOptions();
  }
}

function showEnemyEncounterOptions() {
  currentView = "battle";
  eventActionsDiv.innerHTML = "";

  const attackBtn = document.createElement("button");
  attackBtn.textContent = "‚öîÔ∏è Saldƒ±r";
  attackBtn.onclick = () => startBattle();

  const runBtn = document.createElement("button");
  runBtn.textContent = "üèÉ Ka√ß";
  runBtn.classList.add("ghost");
  runBtn.onclick = () => attemptEscape();

  const talkBtn = document.createElement("button");
  talkBtn.textContent = "üí¨ Konu≈ü";
  talkBtn.classList.add("ghost");
  talkBtn.onclick = () => attemptNegotiation();

  eventActionsDiv.appendChild(attackBtn);
  eventActionsDiv.appendChild(runBtn);
  eventActionsDiv.appendChild(talkBtn);
}

function startBattle() {
  currentView = "battle";
  eventDescriptionDiv.innerHTML = `
    <strong>‚öîÔ∏è SAVA≈û BA≈ûLADI!</strong>
    <div>üõ°Ô∏è Sen: ${player.HP}/${player.maxHP} Can</div>
    <div>üëπ ${currentEnemy.name}: ${currentEnemy.HP}/${currentEnemy.maxHP} Can</div>
  `;
  
  gameLogInsert(`‚öîÔ∏è ${currentEnemy.name} ile d√∂v√º≈ü ba≈üladƒ±!`);
  isPlayerTurn = true; // D√∂v√º≈ü ba≈üladƒ±ƒüƒ±nda sƒ±ra oyuncuda
  renderBattleActions();
}

function renderBattleActions() {
  currentView = "battle";
  eventActionsDiv.innerHTML = "";
  
  const attackBtn = document.createElement("button");
  attackBtn.textContent = "üëä Saldƒ±r";
  attackBtn.onclick = () => performAttack();

  const escapeBtn = document.createElement("button");
  escapeBtn.textContent = "üèÉ Ka√ß";
  escapeBtn.classList.add("ghost");
  escapeBtn.onclick = () => attemptEscape();

  // Yetenek butonlarƒ±nƒ± ekle
  player.specialAbilities.forEach(ability => {
      const abilityBtn = document.createElement("button");
      abilityBtn.textContent = `${ability.name} (${ability.currentCooldown > 0 ? Math.ceil(ability.currentCooldown) + "s" : "Hazƒ±r"})`;
      abilityBtn.disabled = ability.currentCooldown > 0 || player.HP < ability.effect.cost || !isPlayerTurn; // Oyuncu sƒ±rasƒ± deƒüilse yetenek kullanƒ±lamaz
      abilityBtn.onclick = () => useAbility(ability);
      eventActionsDiv.appendChild(abilityBtn);
  });

  eventActionsDiv.appendChild(attackBtn);
  eventActionsDiv.appendChild(escapeBtn);
}

function calculateDamage(attackerStat, defenderStat) {
  const baseDamage = Math.max(1, Math.floor(attackerStat * 0.6));
  const defenseReduction = Math.max(0, Math.floor(defenderStat * 0.3));
  const variance = Math.floor(Math.random() * 3) - 1;
  return Math.max(1, baseDamage - defenseReduction + variance);
}

function performAttack() {
  if (!currentEnemy || !isPlayerTurn) return; // Sadece oyuncu sƒ±rasƒ±ysa saldƒ±r
  
  disableEventActions(true); // Butonlarƒ± devre dƒ±≈üƒ± bƒ±rak
  
  const playerDamage = calculateDamage(player.g, currentEnemy.def);
  currentEnemy.HP -= playerDamage;
  
  gameLogInsert(`‚öîÔ∏è ${currentEnemy.name}'e ${playerDamage} hasar verdin!`);
  
  updateBattleDisplay();
  
  if (currentEnemy.HP <= 0) {
    setTimeout(() => onEnemyDefeated(), 800);
  } else {
    isPlayerTurn = false; // Sƒ±rayƒ± d√º≈ümana ge√ßir
    setTimeout(enemyTurn, 1200);
  }
}

function useAbility(ability) {
    if (ability.currentCooldown > 0 || player.HP < ability.effect.cost || !isPlayerTurn) return; // Sadece oyuncu sƒ±rasƒ±ysa yetenek kullan

    disableEventActions(true); // Butonlarƒ± devre dƒ±≈üƒ± bƒ±rak

    player.HP -= ability.effect.cost; // Yetenek maliyeti
    ability.currentCooldown = ability.cooldown; // Cooldown ba≈ülat

    gameLogInsert(`‚ú® ${ability.name} yeteneƒüini kullandƒ±n!`);

    if (ability.id === "guclu_vurus") {
        const playerDamage = calculateDamage(player.g * ability.effect.damageMultiplier, currentEnemy.def);
        currentEnemy.HP -= playerDamage;
        gameLogInsert(`üí• G√º√ßl√º vuru≈üla ${currentEnemy.name}'e ${playerDamage} hasar verdin!`);
    } else if (ability.id === "hizli_kacis") {
        // Ka√ßƒ±≈ü ≈üansƒ±nƒ± artƒ±r
        attemptEscape(ability.effect.escapeChanceBonus);
        return; // Ka√ßƒ±≈ü denemesi sonrasƒ± d√º≈üman sƒ±rasƒ± gelmesin
    }

    updatePlayerStatsUI();
    updateBattleDisplay();

    if (currentEnemy.HP <= 0) {
        setTimeout(() => onEnemyDefeated(), 800);
    } else {
        isPlayerTurn = false; // Sƒ±rayƒ± d√º≈ümana ge√ßir
        setTimeout(enemyTurn, 1200);
    }
}

function enemyTurn() {
  if (!currentEnemy || currentEnemy.HP <= 0) return;
  
  const enemyDamage = calculateDamage(currentEnemy.atk, player.g);
  player.HP -= enemyDamage;
  
  gameLogInsert(`üëπ ${currentEnemy.name} saldƒ±rdƒ± ve ${enemyDamage} hasar aldƒ±n!`);
  
  updatePlayerStatsUI();
  updateBattleDisplay();
  
  if (player.HP <= 0) {
    setTimeout(() => onPlayerDefeated(), 800);
  } else {
    isPlayerTurn = true; // Sƒ±rayƒ± oyuncuya ge√ßir
    setTimeout(() => disableEventActions(false), 1000); // Butonlarƒ± tekrar etkinle≈ütir
  }
}

function updateBattleDisplay() {
  eventDescriptionDiv.innerHTML = `
    <strong>‚öîÔ∏è SAVA≈û DEVAM EDƒ∞YOR</strong>
    <div>üõ°Ô∏è Sen: <span class="player-hp">${player.HP}/${player.maxHP}</span> Can</div>
    <div>üëπ ${currentEnemy.name}: <span class="enemy-hp">${currentEnemy.HP}/${currentEnemy.maxHP}</span> Can</div>
  `;
  renderBattleActions(); // Yetenek cooldown'larƒ± g√ºncellendiƒüinde butonlarƒ± yenile
}

function attemptEscape(bonusChance = 0) {
  disableEventActions(true);
  
  const escapeChance = Math.min(0.8, (player.h / (player.h + currentEnemy.atk)) + 0.2 + bonusChance);
  const success = Math.random() < escapeChance;
  
  if (success) {
    consecutiveEscapes = 0;
    gameLogInsert(`üèÉ Ba≈üarƒ±yla ka√ßtƒ±n!`);
    currentEnemy = null;
    isPlayerTurn = true; // Ka√ßƒ±≈ü ba≈üarƒ±lƒ±ysa sƒ±ra oyuncuya ge√ßer
    setTimeout(() => renderLocationActions(), 1000);
  } else {
    consecutiveEscapes++;
    gameLogInsert("üèÉ Ka√ßƒ±≈ü ba≈üarƒ±sƒ±z! D√º≈üman seni yakaladƒ±!");
    isPlayerTurn = false; // Ka√ßƒ±≈ü ba≈üarƒ±sƒ±zsa sƒ±ra d√º≈ümana ge√ßer
    setTimeout(enemyTurn, 800);
  }
}

function attemptNegotiation() {
  disableEventActions(true);
  
  if (!currentEnemy.behavior.canBePersuaded) {
    gameLogInsert(`üí¨ ${currentEnemy.name} konu≈ümaya ilgisiz!`);
    isPlayerTurn = false; // M√ºzakere ba≈üarƒ±sƒ±zsa sƒ±ra d√º≈ümana ge√ßer
    setTimeout(enemyTurn, 800);
    return;
  }
  
  const persuasionChance = Math.min(0.7, player.k / (player.k + currentEnemy.atk));
  const success = Math.random() < persuasionChance;
  
  if (success) {
    gameLogInsert(`üí¨ ${currentEnemy.name} ile anla≈ümaya vardƒ±n!`);
    
    const expGain = Math.floor(currentEnemy.maxHP * 0.3);
    player.exp += expGain;
    gameLogInsert(`üïäÔ∏è Barƒ±≈ü√ßƒ±l √ß√∂z√ºm bonusu: +${expGain} EXP`);
    
    currentEnemy = null;
    updatePlayerStatsUI();
    isPlayerTurn = true; // Anla≈üma ba≈üarƒ±lƒ±ysa sƒ±ra oyuncuya ge√ßer
    setTimeout(() => renderLocationActions(), 1200);
  } else {
    gameLogInsert(`üí¨ M√ºzakere ba≈üarƒ±sƒ±z! ${currentEnemy.name} daha da √∂fkelendi!`);
    currentEnemy.atk += 1;
    isPlayerTurn = false; // M√ºzakere ba≈üarƒ±sƒ±zsa sƒ±ra d√º≈ümana ge√ßer
    setTimeout(enemyTurn, 800);
  }
}

function onEnemyDefeated() {
  if (!currentEnemy) return;
  
  consecutiveEscapes = 0;
  fightsWon++;
  
  let expGain = 15 + (currentZone * 3);
  if (currentEnemy.isBoss) expGain = Math.floor(expGain * 3);
  
  player.exp += expGain;
  gameLogInsert(`üèÜ ${currentEnemy.name} yenildi! +${expGain} EXP kazandƒ±n!`);
  
  // D√º≈ümandan altƒ±n d√º≈ü√ºrme
  const goldDrop = Math.floor(Math.random() * (currentEnemy.zone * 5 + 5)); // Zone'a g√∂re altƒ±n d√º≈ü√ºrme
  player.gold += goldDrop;
  gameLogInsert(`üí∞ ${goldDrop} altƒ±n buldun!`);

  updatePlayerStatsUI();
  updateFightsWonDisplay();
  
  // G√∂rev kontrol√º - D√º≈üman yenme g√∂revi
  player.activeQuests.forEach(questId => {
      const quest = quests.find(q => q.id === questId);
      if (quest && quest.objective.type === "defeatEnemy" && quest.objective.enemyName === currentEnemy.name) {
          completeQuest(questId);
      }
  });

  if (currentEnemy.isBoss) {
    gameLogInsert("üéâ B√ñRSGAME tamamlandƒ±! Berat Hoca'yƒ± yendin!");
    setTimeout(() => endGame(true), 2000);
    return;
  }
  
  currentEnemy = null;
  isPlayerTurn = true; // D√º≈üman yenildiƒüinde sƒ±ra oyuncuya ge√ßer
  if (Math.random() < 0.4) {
    setTimeout(findItem, 1000);
  } else {
    setTimeout(checkLevelUp, 800);
  }
}

function onPlayerDefeated() {
  gameLogInsert("üíÄ Yenildin... Hikaye burada sona eriyor.");
  endGame(false);
}

function checkLevelUp() {
  if (player.exp >= player.level * 35) {
    player.level++;
    player.exp = 0;
    
    const hpBonus = 8;
    const statBonus = 1;
    
    player.maxHP += hpBonus;
    player.HP = player.maxHP;
    player.g += statBonus; // G√º√ß otomatik artƒ±yor, diƒüer statlar i√ßin se√ßim eklenebilir
    
    gameLogInsert(`üÜô SEVƒ∞YE ATLADIN! Lv.${player.level}`);
    gameLogInsert(`üìà Max Can +${hpBonus}, G√º√ß +${statBonus}, tam iyile≈ütirme!`);
    
    updatePlayerStatsUI();
  }
  
  setTimeout(() => renderLocationActions(), 1200);
}

function findItem() {
  const itemIndex = pickWeightedIndex(items.map(item => ({...item, weight: 1/item.rarity})));
  const item = items[itemIndex];
  
  if (!item) {
    gameLogInsert("üîç Aradƒ±n ama bir ≈üey bulamadƒ±n.");
    setTimeout(() => renderLocationActions(), 800);
    return;
  }
  
  gameLogInsert(`üéÅ ${item.name} buldun!`);
  addItemToInventory(item);
  
  // G√∂rev kontrol√º - E≈üya bulma g√∂revi
  player.activeQuests.forEach(questId => {
      const quest = quests.find(q => q.id === questId);
      if (quest && quest.objective.type === "findItem" && player.inventory.some(invItem => invItem.id === quest.objective.itemId)) {
          completeQuest(questId);
      }
  });

  setTimeout(() => renderLocationActions(), 1200);
}

function addItemToInventory(item) {
  player.inventory.push(item);
  gameLogInsert(`üìã Envanterine ${item.name} eklendi.`);
  updatePlayerStatsUI(); // Envanter deƒüi≈ütiƒüinde UI'ƒ± g√ºncelle
}

function restEvent() {
  const restAmount = Math.floor(player.maxHP * 0.4);
  player.HP = Math.min(player.maxHP, player.HP + restAmount);
  
  eventDescriptionDiv.innerHTML = `<h4>üò¥ Dinlenme Alanƒ±</h4><p>Huzurlu bir yerde dinlendin. G√º√ßlerin tazelendi.</p>`;
  
  gameLogInsert(`üò¥ Dinlendin ve ${restAmount} Can kazandƒ±n.`);
  updatePlayerStatsUI();
  
  const continueBtn = document.createElement("button");
  continueBtn.textContent = "Devam Et";
  continueBtn.onclick = () => renderLocationActions();
  
  eventActionsDiv.innerHTML = "";
  eventActionsDiv.appendChild(continueBtn);
}

function startFinalBoss() {
  gameLogInsert("üèõÔ∏è Berat Hoca'nƒ±n ofisine ula≈ütƒ±n...");
  gameLogInsert("üëë Final sava≈ü ba≈ülamak √ºzere!");
  gameLogInsert("Bu yol uzun, karanlƒ±k ve zorlu. Ama artƒ±k sen sƒ±radan bir √∂ƒürenci deƒüilsin!");
  
  setTimeout(() => {
    currentEnemy = generateEnemy(currentZone, true);
    startBattle();
  }, 1500);
}

function disableEventActions(disabled) {
  const buttons = eventActionsDiv.querySelectorAll("button");
  buttons.forEach(btn => btn.disabled = !!disabled);
}

function endGame(victory) {
  adventureArea.classList.add("hidden");
  gameStatsDisplay.classList.add("hidden");
  finalPanel.classList.remove("hidden");
  
  finalLog.innerHTML = "";
  
  if (victory) {
    finalLog.innerHTML += `<div><h3>üéâ B√ñRSGAME TAMAMLANDI!</h3></div>`;
    finalLog.innerHTML += `<div>Berat Hoca'yƒ± yendin ve okulun karanlƒ±k sƒ±rlarƒ±nƒ± a√ßƒ±ƒüa √ßƒ±kardƒ±n! Okulda yeni bir d√ºzen doƒüdu. √ñƒürenciler korkudan kurtuldu.</div>`;
    finalLog.innerHTML += `<div style="margin-top:12px;"><strong>üìä Final ƒ∞statistiklerin:</strong></div>`;
    finalLog.innerHTML += `<div>‚Ä¢ Seviye: ${player.level}</div>`;
    finalLog.innerHTML += `<div>‚Ä¢ Kazanƒ±lan D√∂v√º≈ü: ${fightsWon}</div>`;
    finalLog.innerHTML += `<div>‚Ä¢ Final G√º√ß: ${player.g}</div>`;
    finalLog.innerHTML += `<div>‚Ä¢ Final Hƒ±z: ${player.h}</div>`;
    finalLog.innerHTML += `<div>‚Ä¢ Final Karizma: ${player.k}</div>`;
    finalLog.innerHTML += `<div>‚Ä¢ Toplam Altƒ±n: ${player.gold}</div>`;
  } else {
    finalLog.innerHTML += `<div><h3>üíÄ OYUN Bƒ∞TTƒ∞</h3></div>`;
    finalLog.innerHTML += `<div>Yenildin... Berat Hoca'nƒ±n adƒ± bir efsane gibi yƒ±llarca yankƒ±lanacak ve sen sadece unutulmu≈ü bir √∂ƒürenci olacaksƒ±n.</div>`;
    finalLog.innerHTML += `<div style="margin-top:12px;">Ula≈ütƒ±ƒüƒ±n seviye: ${player.level}</div>`;
    finalLog.innerHTML += `<div>Kazanƒ±lan d√∂v√º≈ü: ${fightsWon}</div>`;
    finalLog.innerHTML += `<div>Topladƒ±ƒüƒ±n Altƒ±n: ${player.gold}</div>`;
  }
}

/* ========== YENƒ∞ MEKANƒ∞KLER ========== */

// Envanter Y√∂netimi
function openInventory() {
    currentView = "inventory";
    eventDescriptionDiv.innerHTML = `<h3>üéí Envanter</h3>`;
    eventActionsDiv.innerHTML = "";

    if (player.inventory.length === 0) {
        eventActionsDiv.innerHTML = "<p>Envanterin bo≈ü.</p>";
    } else {
        player.inventory.forEach(item => {
            const itemDiv = document.createElement("div");
            itemDiv.classList.add("inventory-item");
            itemDiv.innerHTML = `<span>${item.name} (${item.description})</span>`;
            
            const actionsDiv = document.createElement("div");
            actionsDiv.classList.add("inventory-item-actions");

            if (item.type === "consumable") {
                const useBtn = document.createElement("button");
                useBtn.textContent = "Kullan";
                useBtn.onclick = () => useItem(item);
                actionsDiv.appendChild(useBtn);
            } else if (item.type === "weapon" || item.type === "armor" || item.type === "accessory") {
                const equipBtn = document.createElement("button");
                equipBtn.textContent = "Ku≈üan";
                equipBtn.onclick = () => equipItem(item);
                actionsDiv.appendChild(equipBtn);
            }
            
            const sellBtn = document.createElement("button");
            sellBtn.textContent = `Sat (${item.value} Altƒ±n)`;
            sellBtn.onclick = () => sellItem(item);
            actionsDiv.appendChild(sellBtn);

            itemDiv.appendChild(actionsDiv);
            eventActionsDiv.appendChild(itemDiv);
        });
    }
    
    const backBtn = document.createElement("button");
    backBtn.textContent = "Geri";
    backBtn.onclick = () => renderLocationActions();
    eventActionsDiv.appendChild(backBtn);
}

function useItem(item) {
    if (item.type === "consumable") {
        if (item.effect.hp) {
            player.HP = Math.min(player.maxHP, player.HP + item.effect.hp);
            gameLogInsert(`üíö ${item.name} kullanƒ±ldƒ±. Can +${item.effect.hp}`);
        }
        // Diƒüer consumable etkileri buraya eklenebilir (√∂rn: stat bonuslarƒ±)
        player.inventory = player.inventory.filter(i => i !== item); // Envanterden kaldƒ±r
    } else {
        gameLogInsert(`${item.name} ≈üu an kullanƒ±lamaz.`);
    }
    updatePlayerStatsUI();
    openInventory(); // Envanteri yeniden render et
}

function equipItem(item) {
    if (!item.slot) {
        gameLogInsert(`${item.name} ku≈üanƒ±labilir bir e≈üya deƒüil.`);
        return;
    }

    // √ñnceki ekipmanƒ± envantere geri koy
    if (player.equipment[item.slot]) {
        player.inventory.push(player.equipment[item.slot]);
        gameLogInsert(`${player.equipment[item.slot].name} envantere geri konuldu.`);
    }
    // Yeni ekipmanƒ± ku≈üan
    player.equipment[item.slot] = item;
    // Envanterden kaldƒ±r
    player.inventory = player.inventory.filter(i => i !== item);
    gameLogInsert(`${item.name} ku≈üanƒ±ldƒ±.`);
    updatePlayerStatsUI(); // Stat√ºleri ve UI'ƒ± yeniden hesapla/g√ºncelle
    openInventory(); // Men√ºy√º yenile
}

function sellItem(item) {
    if (item.value > 0) {
        player.gold += item.value;
        player.inventory = player.inventory.filter(i => i !== item);
        gameLogInsert(`${item.name} ${item.value} altƒ±na satƒ±ldƒ±.`);
        updatePlayerStatsUI();
        openInventory();
    } else {
        gameLogInsert(`${item.name} satƒ±lamaz.`);
    }
}

// G√∂rev Sistemi
function openQuestLog() {
    currentView = "quests";
    eventDescriptionDiv.innerHTML = `<h3>üìú G√∂revler</h3>`;
    eventActionsDiv.innerHTML = "";

    if (player.activeQuests.length === 0 && player.completedQuests.length === 0) {
        eventActionsDiv.innerHTML = "<p>Aktif veya tamamlanmƒ±≈ü g√∂revin yok.</p>";
    } else {
        if (player.activeQuests.length > 0) {
            eventActionsDiv.innerHTML += "<h4>Aktif G√∂revler:</h4>";
            player.activeQuests.forEach(questId => {
                const quest = quests.find(q => q.id === questId);
                if (quest) {
                    const questDiv = document.createElement("div");
                    questDiv.classList.add("quest-item");
                    questDiv.innerHTML = `<span><strong>${quest.name}</strong>: ${quest.description}</span>`;
                    eventActionsDiv.appendChild(questDiv);
                }
            });
        }
        if (player.completedQuests.length > 0) {
            eventActionsDiv.innerHTML += "<h4>Tamamlanmƒ±≈ü G√∂revler:</h4>";
            player.completedQuests.forEach(questId => {
                const quest = quests.find(q => q.id === questId);
                if (quest) {
                    const questDiv = document.createElement("div");
                    questDiv.classList.add("quest-item");
                    questDiv.innerHTML = `<span><strong>${quest.name}</strong>: ${quest.description} (Tamamlandƒ±)</span>`;
                    eventActionsDiv.appendChild(questDiv);
                }
            });
        }
    }
    
    const backBtn = document.createElement("button");
    backBtn.textContent = "Geri";
    backBtn.onclick = () => renderLocationActions();
    eventActionsDiv.appendChild(backBtn);
}

function acceptQuest(questId) {
    const quest = quests.find(q => q.id === questId);
    if (quest && quest.status === "available" && !player.activeQuests.includes(questId)) {
        quest.status = "active";
        player.activeQuests.push(questId);
        gameLogInsert(`Yeni g√∂rev: "${quest.name}" kabul edildi!`);
    } else {
        gameLogInsert(`"${quest.name}" g√∂revi zaten aktif veya kabul edilemez.`);
    }
}

function completeQuest(questId) {
    const quest = quests.find(q => q.id === questId);
    if (quest && quest.status === "active" && player.activeQuests.includes(questId)) {
        // G√∂rev hedefini kontrol et
        let objectiveMet = false;
        if (quest.objective.type === "findItem") {
            objectiveMet = player.inventory.some(invItem => invItem.id === quest.objective.itemId);
        } else if (quest.objective.type === "defeatEnemy") {
            objectiveMet = true; // Bu kƒ±sƒ±m, d√º≈üman yenildiƒüinde zaten tetikleniyor
        }

        if (objectiveMet) {
            quest.status = "completed";
            player.activeQuests = player.activeQuests.filter(id => id !== questId);
            player.completedQuests.push(questId);
            gameLogInsert(`G√∂rev "${quest.name}" tamamlandƒ±!`);
            
            // √ñd√ºlleri ver
            if (quest.rewards.exp) player.exp += quest.rewards.exp;
            if (quest.rewards.item) {
                const rewardItem = items.find(i => i.id === quest.rewards.item);
                if (rewardItem) addItemToInventory(rewardItem);
            }
            if (quest.rewards.gold) player.gold += quest.rewards.gold;
            if (quest.rewards.reputation) {
                for (const faction in quest.rewards.reputation) {
                    if (player.reputation[faction] !== undefined) {
                        player.reputation[faction] += quest.rewards.reputation[faction];
                        gameLogInsert(`${faction} ile itibarƒ±n ${quest.rewards.reputation[faction]} arttƒ±.`);
                    }
                }
            }
            updatePlayerStatsUI();
        } else {
            gameLogInsert(`G√∂rev "${quest.name}" hen√ºz tamamlanmadƒ±. Hedefler kar≈üƒ±lanmadƒ±.`);
        }
    }
}

// Diyalog Sistemi
function startDialogue(dialogueId) {
    currentView = "dialogue";
    currentDialogueState.dialogueId = dialogueId;
    currentDialogueState.currentLineIndex = 0;
    currentDialogueState.currentDialogueData = dialogues[dialogueId];

    if (!currentDialogueState.currentDialogueData) {
        gameLogInsert("Diyalog bulunamadƒ±.");
        renderLocationActions();
        return;
    }
    showDialogueLine();
}

function showDialogueLine() {
    const line = currentDialogueState.currentDialogueData[currentDialogueState.currentLineIndex];

    if (!line) {
        renderLocationActions(); // Diyalog bittiƒüinde normal aksiyonlara d√∂n
        return;
    }

    // Eƒüer metin bir fonksiyon ise, player objesini arg√ºman olarak vererek √ßaƒüƒ±r
    const dialogueText = typeof line.text === 'function' ? line.text(player) : line.text;

    eventDescriptionDiv.innerHTML = `<h4>üí¨ ${line.speaker}</h4><p>${dialogueText}</p>`;
    eventActionsDiv.innerHTML = "";

    line.options.forEach(option => {
        const btn = document.createElement("button");
        btn.textContent = option.text;
        btn.onclick = () => {
            if (option.action) {
                option.action(); // √ñzel bir aksiyon varsa √ßalƒ±≈ütƒ±r (√∂rn: acceptQuest)
            }
            if (option.next === "end") {
                renderLocationActions();
            } else if (typeof option.next === 'number') {
                currentDialogueState.currentLineIndex = option.next;
                showDialogueLine();
            } else if (typeof option.next === 'string') { // Yeni bir diyalog akƒ±≈üƒ±na ge√ßi≈ü
                startDialogue(option.next); // Yeni diyalog ID'si ile ba≈ülat
            } else {
                currentDialogueState.currentLineIndex++;
                showDialogueLine();
            }
        };
        eventActionsDiv.appendChild(btn);
    });
}

// Zanaat Sistemi
function openCraftingMenu() {
    currentView = "crafting";
    eventDescriptionDiv.innerHTML = `<h3>üõ†Ô∏è Zanaat Men√ºs√º</h3>`;
    eventActionsDiv.innerHTML = "";

    if (craftingRecipes.length === 0) {
        eventActionsDiv.innerHTML = "<p>√úretilebilecek tarif yok.</p>";
    } else {
        craftingRecipes.forEach(recipe => {
            const recipeDiv = document.createElement("div");
            recipeDiv.classList.add("inventory-item"); // Stil i√ßin aynƒ± sƒ±nƒ±fƒ± kullan
            
            const ingredientsText = recipe.ingredients.map(ing => {
                const item = items.find(i => i.id === ing.itemId);
                return `${ing.count}x ${item ? item.name : 'Bilinmeyen √ñƒüe'}`;
            }).join(", ");

            const outputItem = items.find(i => i.id === recipe.output.itemId);
            const outputText = `${recipe.output.count}x ${outputItem ? outputItem.name : 'Bilinmeyen √ñƒüe'}`;

            recipeDiv.innerHTML = `<span><strong>${recipe.name}</strong>: ${outputText} (Gerekenler: ${ingredientsText})</span>`;
            
            const craftBtn = document.createElement("button");
            craftBtn.textContent = "√úret";
            craftBtn.disabled = !canCraft(recipe);
            craftBtn.onclick = () => craftItem(recipe);
            recipeDiv.appendChild(craftBtn);
            eventActionsDiv.appendChild(recipeDiv);
        });
    }

    const backBtn = document.createElement("button");
    backBtn.textContent = "Geri";
    backBtn.onclick = () => renderLocationActions();
    eventActionsDiv.appendChild(backBtn);
}

function canCraft(recipe) {
    return recipe.ingredients.every(ing => {
        const playerHas = player.inventory.filter(item => item.id === ing.itemId).length;
        return playerHas >= ing.count;
    });
}

function craftItem(recipe) {
    if (canCraft(recipe)) {
        // Malzemeleri envanterden √ßƒ±kar
        recipe.ingredients.forEach(ing => {
            for (let i = 0; i < ing.count; i++) {
                const index = player.inventory.findIndex(item => item.id === ing.itemId);
                if (index !== -1) {
                    player.inventory.splice(index, 1);
                }
            }
        });
        // √úr√ºn√º envantere ekle
        const outputItem = items.find(i => i.id === recipe.output.itemId);
        if (outputItem) {
            for (let i = 0; i < recipe.output.count; i++) {
                player.inventory.push(outputItem);
            }
            gameLogInsert(`${recipe.output.count} adet ${outputItem.name} √ºrettin!`);
        } else {
            gameLogInsert("√úretim hatasƒ±: √áƒ±ktƒ± √∂ƒüesi bulunamadƒ±.");
        }
        
        updatePlayerStatsUI();
        openCraftingMenu(); // Men√ºy√º yenile
    } else {
        gameLogInsert("Yeterli malzemen yok!");
    }
}


/* ========== OYUN BA≈ûLATMA VE SIFIRLAMA ========== */
function initGame() {
  currentStepIndex = 0;
  currentOptions = [];
  selecting = false;
  selectedClan = null;
  selectedGuc = null; 
  selectedHiz = null;
  selectedKarizma = null;
  selectedHP = null;
  selectedStyle = null;

  player = {
    g: 0, h: 0, k: 0, style: null,
    level: 1, exp: 0,
    HP: 0, maxHP: 0,
    inventory: [],
    equipment: {
      mainHand: null, offHand: null, head: null, body: null, legs: null, feet: null, accessory1: null, accessory2: null
    },
    specialAbilities: [ // Yetenekleri sƒ±fƒ±rla
        { id: "guclu_vurus", name: "G√º√ßl√º Vuru≈ü", cooldown: 3, currentCooldown: 0, effect: { damageMultiplier: 1.5, cost: 5 } },
        { id: "hizli_kacis", name: "Hƒ±zlƒ± Ka√ßƒ±≈ü", cooldown: 5, currentCooldown: 0, effect: { escapeChanceBonus: 0.2, cost: 3 } }
    ],
    activeQuests: [],
    completedQuests: [],
    reputation: { resistance: 0, berat_faction: 0 },
    gold: 0,
    currentLocation: "Okul Ana Binasƒ±",
    timeOfDay: "day",
    weather: "clear",
    timeCounter: 0,
    actionsTaken: 0 // Aksiyon sayacƒ±nƒ± sƒ±fƒ±rla
  };
  currentEnemy = null;
  consecutiveEscapes = 0;
  fightsWon = 0;
  currentZone = 1;
  isPlayerTurn = true; // Oyun sƒ±fƒ±rlandƒ±ƒüƒ±nda sƒ±ra oyuncuda ba≈ülar

  // NPC'lerin konumlarƒ±nƒ± ba≈ülangƒ±√ß durumuna getir
  npcs.forEach(npc => {
      const initialRoutine = npc.routine.find(r => r.time === "day"); // Varsayƒ±lan olarak g√ºnd√ºz konumuna
      if (initialRoutine) {
          npc.currentLocation = initialRoutine.location;
      }
  });

  // G√∂revleri sƒ±fƒ±rla (dinamik g√∂revler de dahil)
  // Sadece ba≈ülangƒ±√ßtaki statik g√∂revleri tut
  const initialQuests = [
    {
      id: "quest_001",
      name: "Kayƒ±p Kitap",
      description: "K√ºt√ºphanede kaybolan eski bir kitabƒ± bul.",
      giver: "K√ºt√ºphaneci Zoktay", // Adƒ± g√ºncellendi
      location: "K√ºt√ºphane",
      objective: { type: "findItem", itemId: "ancient_book_001", count: 1 },
      rewards: { exp: 50, item: "kitap_ayraci_001", gold: 20 },
      status: "available",
      dialogue: {
        start: "Ah, o eski kitap... Onu bulursan sana iyi bir √∂d√ºl veririm.",
        progress: "Kitabƒ± buldun mu?",
        complete: "Harika! ƒ∞≈üte √∂d√ºl√ºn.",
        fail: "Kitap bulunamadƒ±, belki ba≈üka zaman."
      }
    },
    {
      id: "quest_002",
      name: "Berat'ƒ±n Casusu",
      description: "Berat Hoca'nƒ±n casuslarƒ±ndan birini etkisiz hale getir.",
      giver: "Direni≈ü Lideri",
      location: "Okul Bah√ßesi",
      objective: { type: "defeatEnemy", enemyName: "Berat'ƒ±n G√∂zc√ºs√º Yiƒüit Aysu", count: 1 }, // D√º≈üman adƒ± g√ºncellendi
      rewards: { exp: 75, reputation: { resistance: 10 }, gold: 30 },
      status: "available",
      dialogue: {
        start: "Berat'ƒ±n g√∂zc√ºleri her yerde. Birini durdurmalƒ±yƒ±z.",
        progress: "Casusu hallettin mi?",
        complete: "M√ºkemmel! Direni≈ü sana minnettar.",
        fail: "Casus ka√ßtƒ±, dikkatli olmalƒ±yƒ±m."
      }
    }
  ];
  quests.splice(0, quests.length, ...initialQuests); // Global quests dizisini sƒ±fƒ±rla

  statClanEl.textContent = "-";
  statGucEl.textContent = "-";
  statHizEl.textContent = "-";
  statKarizmaEl.textContent = "-";
  statStyleEl.textContent = "-";
  statHPEl.textContent = "-";
  statLevel.textContent = "1";
  statExp.textContent = "0";
  inventoryEl.textContent = "Bo≈ü";
  equipmentDisplayEl.textContent = "Bo≈ü";
  goldDisplayEl.textContent = "0";

  gameStatClanEl.textContent = "-";
  gameStatGucEl.textContent = "-";
  gameStatHizEl.textContent = "-";
  gameStatKarizmaEl.textContent = "-";
  gameStatStyleEl.textContent = "-";
  gameStatHPEl.textContent = "-"; // D√ºzeltildi
  gameStatLevel.textContent = "1";
  gameStatExp.textContent = "0";
  gameInventoryEl.textContent = "Bo≈ü";
  gameEquipmentDisplayEl.textContent = "Bo≈ü";
  gameGoldDisplayEl.textContent = "0";
  fightsWonDisplay.textContent = "0/15";
  gameLocationDisplayEl.textContent = "-";
  gameTimeDisplayEl.textContent = "-";
  gameWeatherDisplayEl.textContent = "-";

  characterCreationPanel.classList.remove("hidden");
  gameContainer.classList.add("hidden");
  document.getElementById("gameIntro").classList.remove("hidden");
  finalPanel.classList.add("hidden");
  startGameBtn.classList.add("hidden");

  selectBtn.disabled = false;
  selectBtn.textContent = "Se√ß";
  
  // Event listener'ƒ± sadece bir kez eklemek i√ßin kontrol
  if (!selectBtn.hasAttribute('data-listener-added')) {
      selectBtn.addEventListener("click", originalSelectBtnOnClick);
      selectBtn.setAttribute('data-listener-added', 'true');
  }

  updateStep();
  gameLog.innerHTML = "";
}

originalSelectBtnOnClick = () => {
  if (selecting) return;
  selecting = true;
  selectBtn.disabled = true;
  stepResult.textContent = "";

  const selectedIndex = pickWeightedIndex(currentOptions);
  if (selectedIndex === -1) {
      stepResult.textContent = "Se√ßim yapƒ±lamadƒ±, se√ßenek yok.";
      selectBtn.disabled = false;
      selecting = false;
      return;
  }
  animateSelection(selectedIndex, () => {
    handleSelection(currentOptions[selectedIndex]);
  });
};

resetBtn.addEventListener("click", initGame);
restartAllBtn.addEventListener("click", initGame);
document.addEventListener("DOMContentLoaded", initGame);

</script>
</body>
</html>
